---
title: "case5_bayesian"
format: html
editor: visual
---

```{r}
load("./strokeStudy.RData")
```

```{r}
library(ggplot2)
library(dplyr)
library(tidyr)
library(knitr)
library(patchwork)

library(rjags)
library(R2jags)
library(coda)
```

# Data cleaning

```{r}
# Missing -> NA for Race2
x$Race2[x$Race2=="Missing"]<-NA
x$Race2<-factor(x$Race2)
```

```{r}
# Mapping of factors to numbers in the next step
show_mapping <- function(f){
  data.frame(
    code  = seq_along(levels(f)),
    level = levels(f)
  )
}

show_mapping(x$siteID)
show_mapping(x$Time2)
show_mapping(x$Gender)
show_mapping(x$Race2)
```

```{r}
# Convert all factors to integer indices
x$siteID  <- as.numeric(factor(x$siteID))   # becomes 1..9
x$Time2   <- as.numeric(factor(x$Time2))    # becomes 1..8
x$Gender  <- as.numeric(factor(x$Gender))   # becomes 1..2
x$Race2   <- as.numeric(factor(x$Race2))    # becomes 1..3
```

```{r}
# Convert logicals to 0/1
logical_vars <- c("hadTPA","hadThrombectomy","tpaComplic","thrComplic","homeOrRehab")
x[logical_vars] <- lapply(x[logical_vars], function(v) as.numeric(v))
```

```{r}
# Convert PreHospNotify (Yes/No) to 0/1
x$PreHospNotify <- ifelse(x$PreHospNotify == "Yes", 1,
                           ifelse(x$PreHospNotify == "No", 0, NA))

# Convert EMSvsCar (currently dbl) to 0/1 integer
x$EMSvsCar <- as.integer(x$EMSvsCar)
```

```{r}
# Set EMSvsCar = 1 if PreHospNotify = 1
x$EMSvsCar[is.na(x$EMSvsCar) & x$PreHospNotify == 1] <- 1
```

# Missingness pattern

```{r}
x$M_A      <- ifelse(is.na(x$Age), 1, 0)
x$M_notify <- ifelse(is.na(x$PreHospNotify), 1, 0)
x$M_trans  <- ifelse(is.na(x$EMSvsCar), 1, 0)
x$M_race   <- ifelse(is.na(x$Race2), 1, 0)
```

```{r}
fit_MA <- glm(
  M_A ~ EMSvsCar + PreHospNotify + hadThrombectomy + hadTPA + tpaComplic + thrComplic + 
    Time2 + Gender + Race2 + siteID,
  data = x,
  family = binomial
)

summary(fit_MA)
```

```{r}
fit_M_notify <- glm(
  M_notify ~ EMSvsCar + hadThrombectomy + hadTPA + tpaComplic + thrComplic + 
    Time2 + Gender + Race2 + siteID,
  data = x,
  family = binomial
)

summary(fit_M_notify)
```

```{r}
fit_M_trans <- glm(
  M_trans ~ hadThrombectomy + hadTPA + tpaComplic + thrComplic + 
    Time2 + Gender + Race2 + siteID,
  data = x,
  family = binomial
)

summary(fit_M_trans)
```

```{r}
fit_M_race <- glm(
  M_race ~ hadThrombectomy + hadTPA + tpaComplic + thrComplic + 
    Time2 + Gender + siteID,
  data = x,
  family = binomial
)

summary(fit_M_race)
```

# Bayesian approach

```{r}
age_mean <- mean(x$Age, na.rm = TRUE)

x <- x |>
  mutate(logAge = log(Age),
         sqrAge = (Age)^2 / 1000,
         Age_c10 = (Age - age_mean) / 10)
```

```{r}
# Build the data list for JAGS
bdat <- list(
  N = nrow(x),
  Y = x$homeOrRehab,
  Site = x$siteID,
  Time = x$Time2,
  Age = x$Age,
  Gender = x$Gender,
  Race = x$Race2,
  Transport = x$EMSvsCar,
  Notify = x$PreHospNotify,
  hadTPA = x$hadTPA,
  hadThrombectomy = x$hadThrombectomy,
  tpaComplic = x$tpaComplic,
  thrComplic = x$thrComplic
)
```

```{r}
fun.params <- c(
  # outcome model
  "beta0","beta_site","beta_time","beta_age","beta_gender","beta_race",
  "beta_transport","beta_notify","beta_TPA","beta_Thromb",
  "beta_tpaComp","beta_thrComp",

  # Race model
  "pi_race",

  # Transport model
  "gamma0","gamma_site","gamma_Thromb","gamma_TPA",
  "gamma_thrComp","gamma_tpaComp",

  # Notify model
  "delta0","delta_site","delta_time",

  # Age model
  "eta0","eta_site","eta_race","eta_time",
  "sigma_A"
)
```

```{r}
set.seed(440)
fun.model.file <- "model_stroke.R" 
mcmc.pars <- list(iter = 10000, burn = 2000, nchain=4, thin=1)

# jags.out <- jags(
#   data = bdat,
#   inits = NULL,
#   parameters.to.save = fun.params,
#   model.file = fun.model.file,
#   n.chains = mcmc.pars$nchain,
#   n.iter = mcmc.pars$iter,
#   n.burnin = mcmc.pars$burn,
#   n.thin = mcmc.pars$thin,
#   DIC = FALSE,
#   progress.bar = "none"
# )
```

```{r}
load("./bayes_model_run_final.RData")
```

## Evaluation

```{r}
sim <- as.mcmc(jags.out)
ess <- effectiveSize(sim)
ess
```

```{r}
df_ess <- data.frame(
  parameter = names(ess),
  ESS = as.numeric(ess)
)

df_beta <- df_ess[grepl("^beta", df_ess$parameter), ]

ggplot(df_beta, aes(x = reorder(parameter, ESS), y = ESS)) +
  geom_col() +
  coord_flip() +
  labs(title = "Effective Sample Size by Parameter",
       x = "Parameter",
       y = "ESS") +
  theme_minimal()
```

```{r}
# traceplot(sim, varname = fun.params)
```

```{r}
gelman.diag(sim, transform=TRUE)
```

```{r}
gelman_results <- gelman.diag(sim, transform=TRUE)
psrf_df <- as.data.frame(gelman_results$psrf)
psrf_df$Parameter <- rownames(psrf_df)
colnames(psrf_df) <- c("Point_Est", "Upper_CI", "Parameter")
```

```{r}
psrf_beta <- psrf_df |> 
  filter(grepl("^beta", Parameter))

ggplot(psrf_beta, aes(x = Point_Est, y = reorder(Parameter, Point_Est))) +
  geom_point(size = 2, color = "steelblue") +
  geom_errorbarh(aes(xmin = Point_Est, xmax = Upper_CI),
                 height = 0.15, color = "gray50") +
  geom_vline(xintercept = 1, linetype = "solid", color = "darkgray") +
  geom_vline(xintercept = 1.01, linetype = "dashed", color = "orange") +
  geom_vline(xintercept = 1.05, linetype = "dashed", color = "red") +
  coord_cartesian(xlim = c(0.995, 1.06)) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.y = element_text(size = 8),
    panel.grid.major.y = element_blank()
  ) +
  labs(
    y = "",
    x = expression(hat(R)),
    title = "Gelman–Rubin Diagnostic for β Parameters"
  )
```

```{r}
rl <- raftery.diag(sim)
rl[[1]]
```

```{r}
# Combine the resmatrix data for all chains
df_list <- lapply(rl, function(x) as.data.frame(x$resmatrix))

# Get common parameter names
common_params <- Reduce(intersect, lapply(df_list, rownames))

# Average across chains
df_mean <- Reduce("+", lapply(df_list, function(df) df[common_params, ])) / length(df_list)

# Clean column names
colnames(df_mean) <- c("Burn_in_M", "Total_N", "Lower_bound_Nmin", "Dependence_I")

# Drop Lower_bound_Nmin
df_mean <- subset(df_mean, select = -Lower_bound_Nmin)

# Sort and select top 10 by Dependence_I
df_top10 <- df_mean[order(-df_mean$Dependence_I), ][1:10, ]

kable(df_top10, digits = 2, align = "c",
      caption = "Top 10 Parameters by Mean Dependence Factor (Averaged Across Chains)")
```

```{r}
post_summary <- summary(sim)
post_summary[[1]]
```

```{r}

credible_ints<-jags.out$BUGSoutput$summary[,c("2.5%","97.5%")]|>as.data.frame()

credible_ints_filtered<-credible_ints|>filter(`2.5%`<=0&`97.5%`>=0)

credible_ints_filtered|>kable()

```

```{r}
stats <- post_summary$statistics
quants <- post_summary$quantiles

idx_beta <- grepl("^beta", rownames(stats))

beta_stats <- stats[idx_beta, ]
beta_quants <- quants[idx_beta, ]

ci_exclude_zero <- (beta_quants[,"2.5%"] > 0) | (beta_quants[,"97.5%"] < 0)

beta_table <- data.frame(
  Parameter = rownames(beta_stats),
  Mean = beta_stats[,"Mean"],
  CI_lower = beta_quants[,"2.5%"],
  CI_upper = beta_quants[,"97.5%"]
)

beta_sig <- beta_table[ci_exclude_zero, ]

kable(beta_sig, digits = 3, row.names = FALSE)
```

```{r}
post <- do.call(rbind, sim)

selected_betas <- c(
  "beta_age",
  "beta_gender[1]",
  "beta_race[1]",
  "beta_transport",
  "beta_notify",
  "beta_TPA",
  "beta_Thromb",
  "beta_tpaComp",
  "beta_thrComp",
  "beta_site[1]",
  "beta_time[1]"
)

beta_post <- post[, selected_betas, drop = FALSE]

df_long <- as.data.frame(beta_post) |>
  mutate(iter = 1:n()) |>
  pivot_longer(
    cols = all_of(selected_betas),
    names_to = "Parameter",
    values_to = "Posterior"
  )

prior_mean <- 0
prior_sd   <- sqrt(1 / 0.001)

ggplot(df_long, aes(x = Posterior)) +
  geom_density(fill = "steelblue", alpha = 0.4, size = 0.6) +
  stat_function(
    fun = dnorm,
    args = list(mean = prior_mean, sd = prior_sd),
    color = "red", linetype = "dashed", size = 0.7
  ) +
  facet_wrap(~ Parameter, scales = "free", ncol = 4) +
  theme_minimal(base_size = 13) +
  labs(
    title = "Posterior vs Prior for β Parameters",
    subtitle = "Posterior densities (blue) vs diffuse Normal prior (red dashed)",
    x = "Coefficient Value",
    y = "Density"
  ) +
  scale_x_continuous(n.breaks = 4)
```

```{r}
vars <- varnames(sim)
sim_mat <- do.call(rbind, sim)

beta0     <- sim_mat[, "beta0"]
beta_site <- sim_mat[, grep("^beta_site\\[", vars)]
beta_time <- sim_mat[, grep("^beta_time\\[", vars)]
beta_gender <- sim_mat[, grep("^beta_gender\\[", vars)]
beta_race   <- sim_mat[, grep("^beta_race\\[", vars)]
beta_age      <- sim_mat[, "beta_age"]
beta_trans    <- sim_mat[, "beta_transport"]
beta_notify   <- sim_mat[, "beta_notify"]
beta_TPA      <- sim_mat[, "beta_TPA"]
beta_Thromb   <- sim_mat[, "beta_Thromb"]
beta_tpaComp  <- sim_mat[, "beta_tpaComp"]
beta_thrComp  <- sim_mat[, "beta_thrComp"]

Site            <- x$siteID
Time            <- x$Time2
Age             <- x$Age
Gender          <- x$Gender
Race            <- x$Race2
Transport       <- x$EMSvsCar           # 1 = EMS, 0 = Car
Notify          <- x$PreHospNotify
hadTPA          <- x$hadTPA
hadThrombectomy <- x$hadThrombectomy
tpaComplic      <- x$tpaComp
thrComplic      <- x$thrComp
Y               <- x$homeOrRehab        # 1 = home, 0 = rehab

M <- nrow(sim_mat)
N <- length(Y)

lp <- matrix(0, nrow = M, ncol = N)

lp <- lp +
  beta0 + 
  beta_site[, Site] +
  beta_time[, Time] +
  beta_age * matrix(Age, M, N, TRUE) +
  beta_gender[, Gender] +
  beta_race[, Race] +
  beta_trans * matrix(Transport, M, N, TRUE) +
  beta_notify * matrix(Notify, M, N, TRUE) +
  beta_TPA * matrix(hadTPA, M, N, TRUE) +
  beta_Thromb * matrix(hadThrombectomy, M, N, TRUE) +
  beta_tpaComp * matrix(tpaComplic, M, N, TRUE) +
  beta_thrComp * matrix(thrComplic, M, N, TRUE)

invlogit <- function(x) 1 / (1 + exp(-x))
p_samples <- invlogit(lp)

p_mean <- colMeans(p_samples)
library(pROC)
roc_obj <- roc(Y, p_mean)
auc(roc_obj)
plot(roc_obj)
```
