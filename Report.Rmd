---
title: "Report"
author: "Sreya Gnanavel, Srika Gopal, Olivia Fu"
date: "2025-11-13"
output: 
  bookdown::pdf_document2:
    number_sections: true
    toc: false
---

# Background

Stroke is a time-sensitive medical emergency and remains a leading cause of death and long-term disability in the United States. Many patients fail to recognize stroke symptoms or delay seeking treatment, and clinical outcomes worsen substantially with each minute that reperfusion therapy is delayed. Timely diagnosis and rapid initiation of treatment, either thrombolysis (TPA), mechanical thrombectomy, or both, are therefore central to improving survival and functional recovery.

To address delays in stroke care delivery, a regional quality-improvement program was implemented across nine comprehensive stroke centers between 2019 and 2020. The first two quarters of the study represent a baseline planning period, the next four quarters correspond to active implementation, and the final two quarters reflect the fully operational program. Data were collected quarterly on all ischemic stroke patients who received reperfusion therapy and presented to participating centers.

The primary research question is whether the probability of a good discharge outcome:

1.  Defined as discharge to home or a rehabilitation facility rather than to skilled nursing, hospice, or death improved over the course of the program
2.  A secondary goal is to characterize which demographic, clinical, and treatment factors are associated with good outcomes.

## The Data

The dataset contains 1,752 patient encounters with patient demographics, arrival mode (EMS vs. car), pre-hospital notification status, treatment characteristics, complications, and discharge disposition. However, several variables show substantial missingness, specifically age (46%), pre-hospital notification (12%), EMS vs. car (5%), Race2 (5%), and the outcome variable (3%) (Figure @ref(fig:eda1)). Missingness varies by site, by study quarter, and by outcome category, ruling out a Missing Completely at Random (MCAR) and suggesting a approach to handling Missing at Random (MAR) patterns (Figure @ref(fig:eda3)).

Because the outcome depends on multiple partially observed predictors, and because missingness is structured by site and time, the analysis requires both a careful exploratory evaluation of missing-data patterns and a joint modeling framework that appropriately handles incomplete covariates. Multiple Imputation by Chained Equations (MICE) is therefore used to create complete datasets under an MAR assumption, which are then analyzed using frequentist logistic regression and mixed-effects models to assess both patient-level associations and changes in outcomes over time (Figure @ref(fig:eda4)).

# Exploratory Data Analysis

We began by examining patterns of missingness across the dataset, since five key variables, Age (46%), PreHospNotify (12%), EMSvsCar (5%), Race2 (5%), and the outcome homeOrRehab (3%), contained missing values. Age had by far the highest proportion of missingness, and visualizations showed that missingness was not randomly distributed. Instead, it varied substantially by site and study quarter: Age and PreHospNotify were heavily missing in the early baseline period (Y1Q1), then steadily improved in later quarters, consistent with early implementation and documentation challenges. Certain hospitals exhibited extreme patterns (e.g., Site 170 with nearly all Age values missing), suggesting site-level operational or reporting issues. Missingness also differed across levels of the outcome, particularly for PreHospNotify and Age, indicating that the probability of being missing relates to other observed variables. Together, these patterns allowed us to rule out MCAR and conclude that the missingness mechanism is most consistent with Missing at Random (MAR), motivating the use of MICE with predictive mean matching (Figure @ref(fig:eda3)). Diagnostics from the imputation process showed stable mean and variance traces across all five imputations, indicating good convergence(Figure @ref(fig:eda4)).

Beyond missingness, we explored how demographic and clinical characteristics varied across sites and how they related to discharge disposition. Age distributions differed meaningfully by center, and racial composition varied, with some sites treating predominantly Caucasian patients while others had higher proportions of African American or Other race groups. Associations with the outcome followed clinically plausible patterns: patients experiencing TPA or thrombectomy complications had substantially worse outcomes, EMS transport (a proxy for stroke severity) was associated with a lower probability of home/rehab discharge, and TPA treatment corresponded to improved outcomes. Older age, female gender, and African American/Other race groups showed lower rates of favorable discharge. When outcomes were plotted over time, several sites displayed modest improvement from baseline to the end of the study period, though the magnitude varied widely by hospital. These observations underscored the need for statistical modeling that accounts for site heterogeneity, temporal trends, and the non-random missingness structure identified in the EDA.

# Model Rationale, Evaluation, and Results

## Frequentist Model

Given our goals, identifying factors associated with good discharge outcomes and assessing whether outcomes improved over time, we used a regression framework that adjusts for demographic, clinical, and treatment variables. Because patients were clustered within nine stroke centers and our EDA showed meaningful site-level differences, we first fit a mixed-effects logistic regression with a random intercept for site prior to moving to the Bayesian model. To capture broader temporal trends and reduce quarter-to-quarter noise, we collapsed the study timeline into three periods (baseline, middle, end). Age was centered for numerical stability. After completing multiple imputation, we fit this mixed-effects logistic regression on one completed dataset to obtain initial frequentist estimates.

$$
logit(P(homeOrRehab=1))=β_0​+ β_{\text{EMS}}​+β_{\text{PreHospNotify}}​+β_{\text{TPA}}+β_{\text{Thrombectomy}}+β_{\text{Complications}}+β_{\text{Age}}​+β_{\text{Period}}+β_{\text{Gender}}+β_{\text{Race}}+usiteID​.
$$

Model convergence was successful using the bobyqa optimizer. Residual diagnostics, including Pearson residual vs. fitted plots and binned residual plots, indicated no major systematic deviations, though typical heteroskedasticity patterns were present due to the binary outcome. Classification performance was moderate: overall accuracy was 77%, with high sensitivity (0.92) but lower specificity (0.41), reflecting that the model predicts good outcomes more reliably than poor ones.

Parameter estimates aligned with clinical expectations. Older age significantly decreased the odds of a good outcome (β = −0.068, p \< 0.001), as did thrombectomy treatment, TPA complications, and thrombectomy complications, likely reflecting the underlying stroke severity of these patients. The effect of age is strong and approximately linear, though mild curvature suggests that a nonlinear term or spline could improve fit. Treatment effects likely vary with age, but current models do not include interaction terms; exploring age × treatment interactions may clarify differential treatment responses across age groups. Female gender and African American race were also associated with lower odds of home/rehab discharge. However, TPA treatment significantly increased the odds of a good outcome (β = 0.467, p = 0.005). Arrival by EMS was associated with worse outcomes relative to car arrival, again consistent with EMS transporting more severe cases.

The program's time period effect was modest. The middle period did not differ significantly from baseline, while the end period showed a positive but borderline significant increase in good outcomes (β = 0.285, p = 0.099). This suggests a possible improvement in outcomes as the program reached full implementation, though the evidence is not strong at the frequentist 5% significance level.

## **Bayesian Model**

### **Rationale and Implementation**

### **Evaluation**

### Results

# Limitations, Future Directions, and Conclusion

\newpage

# Appendix

```{r echo = FALSE, message = FALSE, warning = FALSE}
load("./strokeStudy.RData")
```

```{r echo = FALSE, message = FALSE, warning = FALSE}
library(ggplot2)
library(naniar)
library(dplyr)
library(tidyr)
library(knitr)
library(patchwork)
```

# EDA

## Missing values

```{r missing, cache=TRUE, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}

# Missing -> NA for Race2
x <- x %>%
  mutate(
    Race2 = na_if(Race2, "Missing"),
    EMSvsCar = case_when(
      EMSvsCar == 1 ~ "EMS",
      EMSvsCar == 0 ~ "Car",
      TRUE ~ NA_character_
    ),
    EMSvsCar = factor(EMSvsCar)
  )
```

```{r label = "eda1", echo = FALSE, warning = FALSE, message = FALSE, fig.cap = "Table missing values", fig.show = 'hold'}
missing_count <- x |>
  dplyr::select(-Time2, -siteID) |>
  summarise(across(
    everything(),
    ~ sum(is.na(.))
  )) |>
  pivot_longer(everything(),
               names_to = "Variable",
               values_to = "n_missing") %>%
  arrange(desc(n_missing))

kable(missing_count)
```

```{r label = "eda2", echo = FALSE, warning = FALSE, message = FALSE, fig.cap = "Missing Value Counts Over Time by Quarter", fig.show = 'hold'}
vars_to_check <- c("Age", "PreHospNotify", "EMSvsCar", "homeOrRehab", "Race2")

missing_by_time <- x |>
  group_by(Time2) |>
  summarise(across(all_of(vars_to_check), ~sum(is.na(.)))) |>
  pivot_longer(-Time2, names_to = "Variable", values_to = "n_missing")

ggplot(missing_by_time, aes(x = Time2, y = n_missing, group = Variable, color = Variable)) +
  geom_line(size = 1) +
  geom_point(size = 3) +
  labs(title = "Missing Value Counts by Quarter",
       x = "Time (Quarter)",
       y = "Number of Missing Values",
       color = "Variable") +
  theme_minimal(base_size = 14) +
  scale_color_brewer(palette = "Set2")
```

## Missing Data Analysis

```{r}
library(naniar)
vis_miss(x)

gg_miss_var(x)
gg_miss_fct(x,fct=homeOrRehab)

gg_miss_fct(x |> dplyr::select(where(~ any(is.na(.)))),fct=homeOrRehab)

x_subset<-x
x_subset$missingvals<-is.na(x)
#summary(glm(missingvals~homeOrRehab,data=x_subset))

#checking for mcar
complete_subset<- x[complete.cases(x),]
incomplete_subset<-x[!complete.cases(x),]

summary(complete_subset)
summary(incomplete_subset)

ggplot(x,aes(x=homeOrRehab,fill=complete.cases(x)))+geom_density(alpha=0.5) #not mcar, must be mnar or mar
```

```{r}
library(naniar)
library(ggplot2)
x %>%
  dplyr::select(where(~ any(is.na(.)))) %>%  
  vis_miss()

gg_miss_upset(x)
```

```{r label = "eda3", echo = FALSE, warning = FALSE, message = FALSE, fig.cap = "Missing Heatmap by Quarter by Variable", fig.show = 'hold'}
library(tidyr)

vars_with_missing <- c("Age", "Race2", "EMSvsCar", "PreHospNotify", "homeOrRehab")

x |>
  mutate(across(all_of(vars_with_missing),
                ~ as.integer(is.na(.)),
                .names = "{.col}_miss")) %>%
  
  pivot_longer(
    cols = ends_with("_miss"),
    names_to = "Variable",
    values_to = "Missing"
  ) %>%
  
  group_by(Time2, Variable) %>%
  summarise(prop_missing = mean(Missing), .groups = "drop") %>%
  
  ggplot(aes(x = Time2, y = Variable, fill = prop_missing)) +
  geom_tile() +
  scale_fill_viridis_c(option = "plasma", name = "% Miss") +
  labs(
    title = "Missingness Heatmap by Quarter",
    x = "Study Quarter",
    y = "Variable"
  ) +
  theme_minimal() +
  scale_y_discrete(labels = ~ gsub("_miss", "", .x))
```

## Data cleaning after knowing its not MCAR

```{r label = "eda4", echo = FALSE, warning = FALSE, message = FALSE, fig.cap = "Imputation Plots  for each variable", fig.show = 'hold'}
library(mice)

imp <- mice(x, m = 5, method = "pmm", seed = 2025)
plot(imp)
full_x <- complete(imp, 1)
```

## Covariates & Associations

```{r label = "eda5", echo = FALSE, warning = FALSE, message = FALSE, fig.cap = "Age Distribution by Site 1-9", fig.show = 'hold'}
ggplot(x, aes(x = Age)) +
  geom_histogram(bins = 20) +
  facet_wrap(~ siteID) +
  labs(title = "Age Distribution by Site", x="Age", y="Count") +
  theme_minimal()
```

```{r label = "eda6", echo = FALSE, warning = FALSE, message = FALSE, fig.cap = "Gender Distribution by each Site", fig.show = 'hold'}

x |>
  group_by(siteID, Gender) |>
  summarise(n = n()) |>
  ggplot(aes(x = siteID, y = n, fill = Gender)) +
  geom_bar(stat="identity", position="fill") +
  labs(title="Gender Distribution by Site", y="Proportion") +
  theme_minimal()
```

```{r label = "eda7", echo = FALSE, warning = FALSE, message = FALSE, fig.cap = "Patient discharge outcomes by treatment", fig.show = 'hold'}
p1 <- ggplot(x, aes(x = hadTPA, fill = homeOrRehab)) +
  geom_bar(position = "fill") +
  labs(title = "By TPA Treatment", y = "Proportion") +
  theme_minimal()

p2 <- ggplot(x, aes(x = hadThrombectomy, fill = homeOrRehab)) +
  geom_bar(position = "fill") +
  labs(title = "By Thrombectomy", y = "Proportion") +
  theme_minimal()

p3 <- ggplot(x, aes(x = PreHospNotify, fill = homeOrRehab)) +
  geom_bar(position = "fill") +
  labs(title = "By Pre-Hospital Notification", y = "Proportion") +
  theme_minimal()

p4 <- ggplot(x, aes(x = EMSvsCar, fill = homeOrRehab)) +
  geom_bar(position = "fill") +
  labs(title = "By Arrival Method", y = "Proportion") +
  theme_minimal()

p5 <- ggplot(x, aes(x = thrComplic, fill = homeOrRehab)) +
  geom_bar(position = "fill") +
  labs(title = "By Thrombectomy \nComplications", y = "Proportion") +
  theme_minimal()

p6 <- ggplot(x, aes(x = tpaComplic, fill = homeOrRehab)) +
  geom_bar(position = "fill") +
  labs(title = "By TPA \nComplications", y = "Proportion") +
  theme_minimal()

(p1 + p2 + p3) / (p6 + p5 + p4) +
  plot_layout(guides = "collect") +
  plot_annotation(
    title = "Patient Discharge Outcomes by Treatment and Pre-Hospital Factors"
  )
```

```{r}
p5 <- ggplot(x, aes(x = Gender, fill = homeOrRehab)) +
  geom_bar(position = "fill") +
  labs(title="Outcome by Gender", y="Proportion") +
  theme_minimal()

p6 <- ggplot(x, aes(x = Race2, fill = homeOrRehab)) +
  geom_bar(position = "fill") +
  labs(title = "Outcome by Race", y = "Proportion") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

(p5+p6) +
  plot_layout(guides = "collect") +
  theme(legend.position = "right")
```

```{r}
x |>
  group_by(Time2, siteID) |>
  summarise(
    n = sum(!is.na(homeOrRehab)),
    GoodOutcome = mean(homeOrRehab, na.rm = TRUE),
    SE = sqrt(GoodOutcome * (1 - GoodOutcome) / n),
    .groups = "drop"
  ) |>
  ggplot(aes(x = Time2, y = GoodOutcome, group = siteID)) +
  geom_line() +
  geom_point() +
  geom_errorbar(aes(ymin = GoodOutcome - SE, ymax = GoodOutcome + SE),
                width = 0.1, alpha = 0.6) +
  facet_wrap(~siteID) +
  labs(
    title = "Proportion of Good Outcomes by Site Over Time",
    y = "Proportion Discharged to Home/Rehab",
    x = "Quarter"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

# Frequentist model

```{r}
full_x <- full_x |>
  mutate(
    period = case_when(
      Time2 %in% c("Y1Q1", "Y1Q2") ~ "baseline",
      Time2 %in% c("Y1Q3", "Y1Q4", "Y2Q1", "Y2Q2") ~ "middle",
      Time2 %in% c("Y2Q3", "Y2Q4") ~ "end"
    ),
    period = factor(period, levels = c("baseline", "middle", "end"))
  )
```

```{r}
full_x <- full_x |> 
  mutate(Age_c = Age - mean(Age)) 

ctrl <- glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 1e6) ) 

model_mixed <- glmer( 
  homeOrRehab ~ EMSvsCar + PreHospNotify + hadThrombectomy + 
    hadTPA + tpaComplic + thrComplic + Age_c + period + Gender + Race2 + 
    (1 | siteID), 
  data = full_x, family = binomial, control = ctrl ) 

summary(model_mixed)
```

```{r}
full_x$resid <- residuals(model_mixed, type = "pearson")
full_x$fitted <- fitted(model_mixed)

ggplot(full_x, aes(x = fitted, y = resid)) +
  geom_point(alpha = 0.6) +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  labs(title = "Pearson Residuals vs Fitted Values",
       x = "Fitted Values",
       y = "Pearson Residuals") +
  theme_minimal()

library(arm)
binnedplot(fitted(model_mixed), residuals(model_mixed, type = "pearson"),
           xlab = "Fitted probabilities",
           ylab = "Average Pearson residuals",
           main = "Binned Residual Plot")
```

```{r}
full_x$pred_prob <- predict(model_mixed, type = "response")
y_true <- full_x$homeOrRehab

library(pROC)
library(ggplot2)

roc_df <- data.frame(
  tpr = roc_obj$sensitivities,
  fpr = 1 - roc_obj$specificities
)

ggplot(roc_df, aes(x = fpr, y = tpr)) +
  geom_line(color = "blue", size = 1.2) +
  geom_abline(linetype = "dashed") +
  coord_fixed(xlim = c(0,1), ylim = c(0,1)) +  # square
  labs(x = "False Positive Rate (1 - Specificity)",
       y = "True Positive Rate (Sensitivity)",
       title = "ROC Curve") +
  theme_bw(base_size = 14)
```

```{r}
library(caret)

threshold <- 0.5
full_x$pred_class <- ifelse(full_x$pred_prob > threshold, 1, 0)
full_x$homeOrRehab <- ifelse(full_x$homeOrRehab, 1, 0)

confusionMatrix(
  factor(full_x$pred_class),
  factor(full_x$homeOrRehab),
  positive = "1"
)
```
