---
title: "STA 440 Case 5: Stroke Outcome"
author: "Sreya Gnanavel, Srika Gopal, Olivia Fu"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
format: 
  pdf:
    documentclass: article
    fontsize: 11pt
geometry: margin=1in
execute: 
  warning: false
  message: false
  echo: false
---

# Background

Stroke is a time-sensitive medical emergency and remains a leading cause of death and long-term disability in the United States. Many patients fail to recognize stroke symptoms or delay seeking treatment, and clinical outcomes worsen substantially with each minute that reperfusion therapy is delayed. Timely diagnosis and rapid initiation of treatment, either thrombolysis (TPA), mechanical thrombectomy, or both, are therefore central to improving survival and functional recovery.

To address delays in stroke care delivery, a regional quality-improvement program was implemented across nine comprehensive stroke centers between 2019 and 2020. The first two quarters of the study represent a baseline planning period, the next four quarters correspond to active implementation, and the final two quarters reflect the fully operational program. Data were collected quarterly on all ischemic stroke patients who received reperfusion therapy and presented to participating centers.

The primary research question is whether the probability of a good discharge outcome, defined as discharge to home or a rehabilitation facility rather than to skilled nursing, hospice, or death, (1) improved over the course of the program and (2) is associated with demographic, clinical, and treatment factors.

# Exploratory Data Analysis

The dataset contains 1,752 patient encounters with information on demographics, arrival mode (EMS vs. car), pre-hospital notification status, treatment characteristics, complications, and discharge disposition. Several variables exhibit substantial missingness, most notably Age (46%), PreHospNotify (12%), EMSvsCar (5%), Race2 (5%), and the outcome variable (3%) (@fig-eda1).

To characterize the missingness mechanism, we examined its distribution across key dimensions. Missingness was not uniform across sites (@fig-eda2); for example, Site 170 reported no Age values, and other variables also showed site-specific gaps, suggesting operational or reporting differences. Missingness also varied over time (@fig-eda3). Age and PreHospNotify were heavily missing in the early baseline period (Y1Q1) and improved in later quarters, consistent with early implementation and documentation challenges. Missingness further differed by outcome level (@fig-eda4), particularly for Age and PreHospNotify, indicating that the probability of being missing relates to other observed variables. Together, these patterns rule out a Missing Completely at Random (MCAR) mechanism. Because the missingness is unlikely to depend on the unobserved values themselves, we proceeded under a Missing at Random (MAR) assumption.

We also explored variation in demographic and clinical characteristics across sites and their relationships with discharge outcomes. Age distributions differed across centers, with some sites treating more older patients (@fig-eda5), and racial composition also varied, with certain hospitals serving predominantly Caucasian patients and others having higher proportions of African American or Other race groups (@fig-eda6). On the other hand, gender, pre-hospital notification, and arrival mode were relatively consistent across sites.

Observed associations with the outcome were clinically consistent. Patients with TPA or thrombectomy complications had much lower probabilities of home/rehab discharge; EMS arrival (a proxy for greater stroke severity) was also associated with worse outcomes, while TPA treatment corresponded to improved discharge disposition (@fig-eda7). Older age, female gender, and African American/Other race groups showed lower rates of favorable discharge (@fig-eda8). When outcomes were plotted over time, several sites showed modest improvement from baseline to the end of the study period, whereas others exhibited fluctuations or even declining trends (@fig-eda9). These observations underscored the need for statistical modeling that accounts for site heterogeneity, temporal trends, and the non-random missingness structure identified in the EDA.

# Model Rationale, Evaluation, and Results

## Frequentist Model


Given our goals, identifying factors associated with good discharge outcomes and assessing whether outcomes improved over time, we used a regression framework that adjusts for demographic, clinical, and treatment variables. Because patients were clustered within nine stroke centers and our EDA showed meaningful site-level differences, we first fit a mixed-effects logistic regression with a random intercept for site prior to moving to the Bayesian model. To capture broader temporal trends and reduce quarter-to-quarter noise, we collapsed the study timeline into three periods (baseline, middle, end). Age was centered for numerical stability. After completing multiple imputation, we fit this mixed-effects logistic regression on one completed dataset to obtain initial frequentist estimates. Our imputation of the missing data was based on a hierarchical structure, for which imputation varied based on whether the variable was hierarchical continuous like Age, binary like PreHospNotify, or multinomal categorical like Race2.

We used multilevel multiple imputation by chained equations (MICE) to address missing data under the MAR assumption. Age was imputed using the `2l.pan` method, which specifies a two-level normal model with a random intercept for site, appropriate for continuous variables exhibiting site-level clustering. Race2 was imputed using `polyreg` to model its multinomial categorical structure. EMSvsCar, PreHospNotify, and homeOrRehab were imputed using `logreg`, consistent with their binary outcomes. We generated 20 imputed datasets in total.

Given our goals of identifying factors associated with good discharge outcomes and evaluating whether outcomes improved over time, we used a regression framework that adjusts for demographic, clinical, and treatment variables. Because patients were clustered within nine stroke centers and the EDA indicated substantial site-level heterogeneity, we fit a mixed-effects logistic regression with a random intercept for site. To capture broader temporal trends and reduce quarter-to-quarter variability, we collapsed the study timeline into three periods (baseline, middle, end). Age was centered for numerical stability. We fit this model to each of the 20 imputed datasets and then pooled the results to account for both the variation within each imputation and the uncertainty across imputations.


$$
\begin{aligned}\text{logit}\{P(\text{homeOrRehab}=1)\}&= \beta_0  + \beta_{\text{EMS}}  + \beta_{\text{PreHospNotify}}  + \beta_{\text{TPA}}  + \beta_{\text{Thrombectomy}}  + \beta_{\text{TPAComp}}  + \beta_{\text{ThrombComp}} \\&\quad + \beta_{\text{Age}}  + \beta_{\text{Period}}  + \beta_{\text{Gender}}  + \beta_{\text{Race}}  + u_{\text{siteID}}\end{aligned}
$$

We fit the logistic mixed-effects model using the `glmer` function from the `lme4` package, with the bobyqa optimizer to improve convergence. The imputations were highly stable across iterations. We examined the binned residual plots for all 20 imputations and found no substantial systematic deviations or concerning residual patterns. For illustration, we present the plot from imputation 1 (@fig-freq1). To evaluate predictive performance, we computed the mean AUC across all 20 imputed models, getting an average of 0.743 (Table 2). We also present the ROC curve for imputation 1 (@fig-freq2), which indicates a model with high sensitivity but relatively weaker specificity, so the model identifies good outcomes more reliably than poor ones.

From the pooled regression results (Table 1), older age was associated with substantially lower odds of a good outcome ($\beta$ = –0.041, p \< 0.001). EMS arrival, thrombectomy treatment, TPA complications, and thrombectomy complications also decreased the odds of home or rehab discharge, likely reflecting greater underlying stroke severity among these patients. In this model, age was assumed to have a linear effect, although nonlinearity is plausible; allowing flexible age terms or incorporating age × treatment interactions may help clarify differential treatment responses across age groups. Female gender and African American race were also associated with lower odds of home/rehab discharge. However, TPA treatment significantly increased the odds of a good outcome ($\beta$ = 0.570, p \< 0.001).

The estimated time-period effects of the program were modest. The middle period did not differ meaningfully from the baseline, while the end period showed a positive, though not conventionally significant, association with improved outcomes ($\beta$ = 0.240, p = 0.175). This suggests a possible improvement in outcomes as the program reached full implementation, though the evidence is not strong at the frequentist 5% significance level, potentially due to site-level variability and the influence of the COVID period.

## **Bayesian Model**

### **Rationale and Implementation**

For the Bayesian analysis, we first specified a likelihood for the outcome variable, homeOrRehab, which is binary. We modeled $\text{homeOrRehab}_i$ as Bernoulli with a logit link, and let the log-odds depend on site (9 centers), time (8 quarterly periods), Age, Gender, Race, Transport mode (EMS vs. car), Pre-hospital notification, TPA, Thrombectomy, and their complications. We experimented with alternative forms for age (log(age), age-squared, and centered age), but these did not improve fit or convergence, so we retained the linear age term. We kept all 8 quarterly time periods because we wanted the Bayesian model to capture quarter-by-quarter variation rather than collapsing the timeline. We also experimented with treating site as a random effect, but this specification did not noticeably improve convergence or model fit, so we used the simpler fixed-effects structure.

Next, we built submodels for the variables with missing data: Race, Transport (EMS vs. car), Pre-hospital notification, and Age. Race has three categories, so we used a multinomial model with site-specific probabilities and Dirichlet priors ($\alpha$ = 0.5). Transport was modeled with a logistic regression that included site and four clinical variables (TPA, Thrombectomy, and their complications). For Pre-hospital notification, we ensured that notification is only possible for EMS arrivals by defining the notification probability as a logistic model for EMS patients (depending on site, race, and time) multiplied by an indicator for EMS transport. Finally, we modeled Age with a normal distribution whose mean varies by site, race, and time. We selected the linear predictors in each missing-data model based on regressions of the missingness indicators and our reasoning about which variables were likely to influence each missingness pattern.

We assigned weakly informative priors to all regression coefficients, specifying Normal distributions with mean 0 and precision 0.001. For the Age variance, we placed a Gamma(0.001, 0.001) prior on the precision parameter. The model was estimated in JAGS using four chains, each run for 50,000 iterations with a burn-in of 10,000.

### **Evaluation**

We used standard Bayesian diagnostics for assesment, including trace plots, effective sample sizes (ESS), autocorrelation functions (ACF), and Gelman–Rubin $\hat{R}$ statistics. Trace plots for the primary regression coefficients (age, EMS transport, thrombectomy, tPA treatment, and treatment-related complications) showed tight, overlapping chains with no visible drift or nonstationarity, indicating good mixing. One exception was the age coefficient ($\beta{age}$), which showed slower mixing and a lower ESS relative to other parameters (@fig-bay1). We explored several transformations (log-age, age\^2, centering) to improve mixing, but all versions yielded comparable posterior distributions. Despite the lower ESS, $\beta{age}$ remained well-identified with a narrow posterior, so its interpretation is reliable.

Effective sample sizes for all other fixed-effect parameters were extremely high (often \>150,000), showing good chain independence (@fig-bay1). Autocorrelation diagnostics further supported convergence as the majority of coefficients displayed very rapid decay, indicating weak dependence across MCMC iterations (@fig-bay4). Again, $\beta{age}$ showed modestly slower decay but still stabilized sufficiently for inference (@fig-bay4).

Gelman–Rubin $\hat{R}$ values for all fixed-effect outcome-model parameters were approximately 1.00, with upper bounds below 1.03, meeting the conventional convergence threshold (@fig-bay2). A few parameters belonging to the missing-data submodels (some delta_time and site_gamma effects) showed higher $\hat{R}$ values and wider uncertainty (@fig-bay2). This was expected due to limited identifiability of missingness mechanisms and does not undermine inference for the outcome model.

We compared posterior densities to their corresponding diffuse Normal priors (@fig-bay3). For the main clinical coefficients, the posterior distributions were substantially narrower, showing that the data were informative (@fig-bay3). In contrast, gender, race, site, and time coefficients retained wide posteriors, indicating weak identifiability and imprecision, which is consistent with the high variability in the underlying data (@fig-bay3).

### Results
When evaluating the relative impacts of effects, we looked at the 95% confidence intervals and mean values of the posterior distributions. We found that the effects of age, whether a patient arrived by EMS, having a thrombectomy, and having treatment complications all had confidence intervals not containing 0 (negative values only) and had negative mean values for the posterior distribution, showing us that these factors are associated with worse outcomes for patients. On the other hand, the effect of TPA has a non-negative confidence interval and a positive mean posterior value, hinting that it is the only factor associated with better patient outcomes. 

Based on the posterior distributions of site and time as effects, which did contain 0 in the confidence intervals for the posterior, we find that there is little evidence of strong or time effects. 


# Limitations, Future Directions, and Conclusion

\newpage

# Appendix

```{r}
load("./strokeStudy.RData")
```

```{r}
library(ggplot2)
library(naniar)
library(dplyr)
library(tidyr)
library(knitr)
library(patchwork)
library(lme4)
library(pROC)
library(ggplot2)
library(rjags)
library(R2jags)
library(coda)
```

# EDA

## Missing values

```{r}
# Missing -> NA for Race2
x <- x |>
  mutate(
    Race2 = na_if(Race2, "Missing")
  )
```

## Missing Data Analysis

```{r}
#| label: fig-eda1
#| fig-cap: "Missing Data"

x |>
  select(where(~ any(is.na(.)))) |>
  vis_miss()
```

```{r}
#| label: fig-eda2
#| fig-cap: "Missing Data by Site"

x |>
  select(-Time2) |>
  gg_miss_var(facet = siteID) +
  labs(title = "Missing Data by Variable and Site")
```

```{r}
#| label: fig-eda3
#| fig-cap: "Missing Heatmap by Quarter by Variable"

vars_with_missing <- c("Age", "Race2", "EMSvsCar", "PreHospNotify", "homeOrRehab")

x |>
  mutate(across(all_of(vars_with_missing),
                ~ as.integer(is.na(.)),
                .names = "{.col}_miss")) |>
  
  pivot_longer(
    cols = ends_with("_miss"),
    names_to = "Variable",
    values_to = "Missing"
  ) |>
  
  group_by(Time2, Variable) |>
  summarise(prop_missing = mean(Missing), .groups = "drop") |>
  
  ggplot(aes(x = Time2, y = Variable, fill = prop_missing)) +
  geom_tile() +
  scale_fill_viridis_c(option = "plasma", name = "% Miss") +
  labs(
    title = "Missingness Heatmap by Quarter",
    x = "Study Quarter",
    y = "Variable"
  ) +
  theme_minimal() +
  scale_y_discrete(labels = ~ gsub("_miss", "", .x))
```

```{r}
#| label: fig-eda4
#| fig-cap: "Missingness by outcome"

gg_miss_fct(x,fct=homeOrRehab)
```

## Covariates & Associations

```{r}
#| label: fig-eda5
#| fig-cap: "Age Distribution by Site 1-9"

ggplot(x, aes(x = Age)) +
  geom_histogram(bins = 20) +
  facet_wrap(~ siteID) +
  labs(title = "Age Distribution by Site", x="Age", y="Count") +
  theme_minimal()
```

```{r}
#| label: fig-eda6
#| fig-cap: "Demographic Distribution by Site"

p7 <- x |>
  group_by(siteID, Gender) |>
  summarise(n = n()) |>
  ggplot(aes(x = siteID, y = n, fill = Gender)) +
  geom_bar(stat="identity", position="fill") +
  labs(title="Gender Distribution by Site", y="Proportion") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

p8 <- x |>
  group_by(siteID, Race2) |>
  summarise(n = n()) |>
  ggplot(aes(x = siteID, y = n, fill = Race2)) +
  geom_bar(stat="identity", position="fill") +
  labs(title="Race Distribution by Site", y="Proportion") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

p9 <- x |>
  group_by(siteID, PreHospNotify) |>
  summarise(n = n()) |>
  ggplot(aes(x = siteID, y = n, fill = PreHospNotify)) +
  geom_bar(stat="identity", position="fill") +
  labs(title="Notification Distribution by Site", y="Proportion") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

x$EMSvsCar <- factor(as.integer(as.character(x$EMSvsCar)), levels = c(0, 1))

p10 <- x |>
  group_by(siteID, EMSvsCar) |>
  summarise(n = n()) |>
  ggplot(aes(x = siteID, y = n, fill = EMSvsCar)) +
  geom_bar(stat="identity", position="fill") +
  labs(title="Transport Distribution by Site", y="Proportion") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

(p7 + p8) / (p9 + p10)
```

```{r}
#| label: fig-eda7
#| fig-cap: "Patient discharge outcomes by treatment and pre-hospital factors"

p1 <- ggplot(x, aes(x = hadTPA, fill = homeOrRehab)) +
  geom_bar(position = "fill") +
  labs(title = "By TPA Treatment", y = "Proportion") +
  theme_minimal()

p2 <- ggplot(x, aes(x = hadThrombectomy, fill = homeOrRehab)) +
  geom_bar(position = "fill") +
  labs(title = "By Thrombectomy", y = "Proportion") +
  theme_minimal()

p3 <- ggplot(x, aes(x = PreHospNotify, fill = homeOrRehab)) +
  geom_bar(position = "fill") +
  labs(title = "By Pre-Hospital Notification", y = "Proportion") +
  theme_minimal()

p4 <- ggplot(x, aes(x = EMSvsCar, fill = homeOrRehab)) +
  geom_bar(position = "fill") +
  labs(title = "By Arrival Method", y = "Proportion") +
  theme_minimal()

p5 <- ggplot(x, aes(x = thrComplic, fill = homeOrRehab)) +
  geom_bar(position = "fill") +
  labs(title = "By Thrombectomy \nComplications", y = "Proportion") +
  theme_minimal()

p6 <- ggplot(x, aes(x = tpaComplic, fill = homeOrRehab)) +
  geom_bar(position = "fill") +
  labs(title = "By TPA \nComplications", y = "Proportion") +
  theme_minimal()

(p1 + p2 + p3) / (p6 + p5 + p4) +
  plot_layout(guides = "collect") +
  plot_annotation(
    title = "Patient Discharge Outcomes by Treatment and Pre-Hospital Factors"
  )
```

```{r}
#| label: fig-eda8
#| fig-cap: "Patient discharge outcomes by demographic factors"
#| fig-width: 6
#| fig-height: 6

x$AgeGroup <- cut(
  x$Age,
  breaks = c(-Inf, 20, 40, 60, 80, Inf),
  labels = c("0–20", "20–40", "40–60", "60–80", "80+"),
  right = FALSE
)

p_age <- ggplot(x, aes(x = AgeGroup, fill = homeOrRehab)) +
  geom_bar(position = "fill") +
  labs(
    title = "Outcome by Age Group",
    x = "Age Group",
    y = "Proportion"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

p5 <- ggplot(x, aes(x = Gender, fill = homeOrRehab)) +
  geom_bar(position = "fill") +
  labs(title="Outcome by Gender", y="Proportion") +
  theme_minimal()

p6 <- ggplot(x, aes(x = Race2, fill = homeOrRehab)) +
  geom_bar(position = "fill") +
  labs(title = "Outcome by Race", y = "Proportion") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

p_age / (p5+p6) +
  plot_layout(guides = "collect") +
  theme(legend.position = "right")
```

```{r}
#| label: fig-eda9
#| fig-cap: "Outcomes change over time"

x |>
  group_by(Time2, siteID) |>
  summarise(
    n = sum(!is.na(homeOrRehab)),
    GoodOutcome = mean(homeOrRehab, na.rm = TRUE),
    SE = sqrt(GoodOutcome * (1 - GoodOutcome) / n),
    .groups = "drop"
  ) |>
  ggplot(aes(x = Time2, y = GoodOutcome, group = siteID)) +
  geom_line() +
  geom_point() +
  geom_errorbar(aes(ymin = GoodOutcome - SE, ymax = GoodOutcome + SE),
                width = 0.1, alpha = 0.6) +
  facet_wrap(~siteID) +
  labs(
    title = "Proportion of Good Outcomes by Site Over Time",
    y = "Proportion Discharged to Home/Rehab",
    x = "Quarter"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

# Frequentist model

```{r}
# MICE
library(mice)
library(miceadds)

x$siteID <- as.integer(as.factor(x$siteID))
binary_vec <- c("EMSvsCar","PreHospNotify","homeOrRehab")
x[binary_vec] <- lapply(x[binary_vec], function(z) factor(z))
x$Race2 <- factor(x$Race2)

# Initialize method vector
mice_imp <- make.method(x)
mice_imp["Age"]           <- "2l.pan"     # hierarchical continuous
mice_imp["Race2"]         <- "polyreg"    # multinomial categorical
mice_imp["EMSvsCar"]      <- "logreg"     # binary
mice_imp["PreHospNotify"] <- "logreg"     # binary
mice_imp["homeOrRehab"]   <- "logreg"     # binary

# Predictor matrix
pred_matrix <- make.predictorMatrix(x)
pred_matrix["Age", "siteID"] <- -2
```

```{r}
# imp <- mice(
#   x,
#   m = 20,
#   method = mice_imp,
#   predictorMatrix = pred_matrix,
#   cluster = x$siteID,
#   seed = 2025
# )
```

```{r}
# saveRDS(imp, file = "imp_m20.rds")
imp <- readRDS("./imp_m20.rds")
```

```{r}
# ctrl <- glmerControl(optimizer = "bobyqa")
# 
# models <- with(
#   imp,
#   {
#     period <- case_when(
#       Time2 %in% c("Y1Q1", "Y1Q2") ~ "baseline",
#       Time2 %in% c("Y1Q3", "Y1Q4", "Y2Q1", "Y2Q2") ~ "middle",
#       Time2 %in% c("Y2Q3", "Y2Q4") ~ "end"
#     )
#     period <- factor(period, levels = c("baseline","middle","end"))
# 
#     Age_c <- Age - mean(Age, na.rm = TRUE)
# 
#     glmer(
#       homeOrRehab ~ EMSvsCar + PreHospNotify + hadThrombectomy +
#         hadTPA + tpaComplic + thrComplic + Age_c + period + Gender + Race2 +
#         (1 | siteID),
#       family = binomial,
#       control = ctrl
#     )
#   }
# )
```

```{r}
# saveRDS(models, file = "models_glmer_m20.rds")
models <- readRDS("models_glmer_m20.rds")
```

```{r}
est_list  <- lapply(models$analyses, fixef)
vcov_list <- lapply(models$analyses, vcov)
m <- length(est_list)
coef_names <- names(est_list[[1]])

# p x m matrix of estimates
Qmat <- do.call(cbind, lapply(est_list, function(b) b[coef_names]))

# p x m matrix of standard errors
SEmat <- sapply(models$analyses, function(mdl) sqrt(diag(vcov(mdl)[coef_names, coef_names])))
SEmat <- as.matrix(SEmat)
rownames(SEmat) <- coef_names

# pooled estimate
Q_bar <- rowMeans(Qmat)

# within-imputation variance (mean of SE^2)
U_bar <- rowMeans(SEmat^2)

# between-imputation variance
B <- apply(Qmat, 1, var)

# total variance
T_var <- U_bar + (1 + 1/m) * B

# pooled standard error
se_pooled <- sqrt(T_var)

z_val <- Q_bar / se_pooled
p_val <- 2 * (1 - pnorm(abs(z_val)))

pooled_results <- data.frame(
  term      = coef_names,
  estimate  = Q_bar,
  std.error = se_pooled,
  z         = z_val,
  p.value   = p_val
)

kable(pooled_results, digits = 3, row.names = FALSE,
      caption = "Pooled Summary for Frequentist Model")
```

```{r}
pred_list <- lapply(models$analyses, function(m) predict(m, type="response"))
y <- models$analyses[[1]]@frame$homeOrRehab

auc_list <- lapply(pred_list, function(p) roc(y, p)$auc)
auc_summary <- data.frame(
  Metric = c("Mean AUC", "SD of AUC"),
  Value  = c(mean(unlist(auc_list)), sd(unlist(auc_list)))
)

kable(auc_summary, digits = 3, row.names = FALSE,
      caption = "Mean AUC and SD Across 20 Imputations")
```

```{r}
#| label: fig-freq1
#| fig-cap: "Binned Residual Plot for Imputation 1"

m1 <- models$analyses[[1]]
p1 <- predict(m1, type = "response")
y <- ifelse(m1@frame$homeOrRehab == "TRUE", 1, 0)

pearson_res <- (y - p1) / sqrt(p1 * (1 - p1))

library(arm)

binnedplot(
  x     = p1,
  y     = pearson_res,
  xlab = "Fitted Probability",
  ylab = "Pearson Residual",
  main = "Binned Residual Plot (Imputation 1)"
)
```

```{r}
#| label: fig-freq2
#| fig-cap: "ROC plot"

roc_obj <- roc(y, p1)

roc_df <- data.frame(
  tpr = roc_obj$sensitivities,
  fpr = 1 - roc_obj$specificities
)

ggplot(roc_df, aes(x = fpr, y = tpr)) +
  geom_line(color = "blue", size = 1.2) +
  geom_abline(linetype = "dashed") +
  coord_fixed(xlim = c(0,1), ylim = c(0,1)) +
  labs(
    x = "False Positive Rate (1 - Specificity)",
    y = "True Positive Rate (Sensitivity)",
    title = paste("ROC Curve (Imputation 1) | AUC =", round(roc_obj$auc, 3))
  ) +
  theme_bw()
```

### Bayesian Model:

```{r}
load("./strokeStudy.RData")
```

```{r}
x$Race2[x$Race2=="Missing"] <- NA
x$Race2<-factor(x$Race2)

# Convert all factors to integer indices
x$siteID  <- as.numeric(factor(x$siteID))   # becomes 1..9
x$Time2   <- as.numeric(factor(x$Time2))    # becomes 1..8
x$Gender  <- as.numeric(factor(x$Gender))   # becomes 1..2
x$Race2   <- as.numeric(factor(x$Race2))    # becomes 1..3

# Convert logicals to 0/1
logical_vars <- c("hadTPA","hadThrombectomy","tpaComplic","thrComplic","homeOrRehab")
x[logical_vars] <- lapply(x[logical_vars], function(v) as.numeric(v))

# Convert PreHospNotify (Yes/No) to 0/1
x$PreHospNotify <- ifelse(x$PreHospNotify == "Yes", 1,
                           ifelse(x$PreHospNotify == "No", 0, NA))

# Convert EMSvsCar (currently dbl) to 0/1 integer
x$EMSvsCar <- as.integer(x$EMSvsCar)

# Set EMSvsCar = 1 if PreHospNotify = 1
x$EMSvsCar[is.na(x$EMSvsCar) & x$PreHospNotify == 1] <- 1
x$M_A      <- ifelse(is.na(x$Age), 1, 0)
x$M_notify <- ifelse(is.na(x$PreHospNotify), 1, 0)
x$M_trans  <- ifelse(is.na(x$EMSvsCar), 1, 0)
x$M_race   <- ifelse(is.na(x$Race2), 1, 0)
age_mean <- mean(x$Age, na.rm = TRUE)

# Build the data list for JAGS
bdat <- list(
  N = nrow(x),
  Y = x$homeOrRehab,
  Site = x$siteID,
  Time = x$Time2,
  Age = x$Age,
  Gender = x$Gender,
  Race = x$Race2,
  Transport = x$EMSvsCar,
  Notify = x$PreHospNotify,
  hadTPA = x$hadTPA,
  hadThrombectomy = x$hadThrombectomy,
  tpaComplic = x$tpaComplic,
  thrComplic = x$thrComplic
)

fun.params <- c(
  # outcome model
  "beta0","beta_site","beta_time","beta_age","beta_gender","beta_race",
  "beta_transport","beta_notify","beta_TPA","beta_Thromb",
  "beta_tpaComp","beta_thrComp",

  # Race model
  "pi_race",

  # Transport model
  "gamma0","gamma_site","gamma_Thromb","gamma_TPA",
  "gamma_thrComp","gamma_tpaComp",

  # Notify model
  "delta0","delta_site","delta_time",

  # Age model
  "eta0","eta_site","eta_race","eta_time",
  "sigma_A"
)

set.seed(440)
fun.model.file <- "model_stroke.R" 
mcmc.pars <- list(iter = 10000, burn = 2000, nchain=4, thin=1)

# jags.out <- jags(
#   data = bdat,
#   inits = NULL,
#   parameters.to.save = fun.params,
#   model.file = fun.model.file,
#   n.chains = mcmc.pars$nchain,
#   n.iter = mcmc.pars$iter,
#   n.burnin = mcmc.pars$burn,
#   n.thin = mcmc.pars$thin,
#   DIC = FALSE,
#   progress.bar = "none"
# )
```

```{r}
load("bayes_model_run_final.RData")
```

### Bayesian Evaluation:

```{r}
#| label: fig-bay1
#| fig-cap: "ESS for Bayesian Parameters"

sim <- as.mcmc(jags.out)
ess <- effectiveSize(sim)

df_ess <- data.frame(
  parameter = names(ess),
  ESS = as.numeric(ess)
)

df_beta <- df_ess[grepl("^beta", df_ess$parameter), ]

ggplot(df_beta, aes(x = reorder(parameter, ESS), y = ESS)) +
  geom_col() +
  coord_flip() +
  labs(title = "Effective Sample Size by Parameter",
       x = "Parameter",
       y = "ESS") +
  theme_minimal()
```

```{r}
#| label: fig-bay2
#| fig-cap: "Gelman-Rubin Rhat Values for Beta Parameters"

gelman_results <- gelman.diag(sim, transform=TRUE)
psrf_df <- as.data.frame(gelman_results$psrf)
psrf_df$Parameter <- rownames(psrf_df)
colnames(psrf_df) <- c("Point_Est", "Upper_CI", "Parameter")

psrf_beta <- psrf_df |> 
  filter(grepl("^beta", Parameter))

ggplot(psrf_beta, aes(x = Point_Est, y = reorder(Parameter, Point_Est))) +
  geom_point(size = 2, color = "steelblue") +
  geom_errorbarh(aes(xmin = Point_Est, xmax = Upper_CI),
                 height = 0.15, color = "gray50") +
  geom_vline(xintercept = 1, linetype = "solid", color = "darkgray") +
  geom_vline(xintercept = 1.01, linetype = "dashed", color = "orange") +
  geom_vline(xintercept = 1.05, linetype = "dashed", color = "red") +
  coord_cartesian(xlim = c(0.995, 1.06)) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.y = element_text(size = 8),
    panel.grid.major.y = element_blank()
  ) +
  labs(
    y = "",
    x = expression(hat(R)),
    title = "Gelman–Rubin Diagnostic for β Parameters"
  )
```

```{r}
#| label: fig-bay3
#| fig-cap: "Posterior vs. Prior Distributions for the Beta Parameters"

post <- do.call(rbind, sim)

selected_betas <- c(
  "beta_age",
  "beta_gender[1]",
  "beta_race[1]",
  "beta_transport",
  "beta_notify",
  "beta_TPA",
  "beta_Thromb",
  "beta_tpaComp",
  "beta_thrComp",
  "beta_site[1]",
  "beta_time[1]"
)

beta_post <- post[, selected_betas, drop = FALSE]

df_long <- as.data.frame(beta_post) |>
  mutate(iter = 1:n()) |>
  pivot_longer(
    cols = all_of(selected_betas),
    names_to = "Parameter",
    values_to = "Posterior"
  )

prior_mean <- 0
prior_sd   <- sqrt(1 / 0.001)

ggplot(df_long, aes(x = Posterior)) +
  geom_density(fill = "steelblue", alpha = 0.4, size = 0.6) +
  stat_function(
    fun = dnorm,
    args = list(mean = prior_mean, sd = prior_sd),
    color = "red", linetype = "dashed", size = 0.7
  ) +
  facet_wrap(~ Parameter, scales = "free", ncol = 4) +
  theme_minimal(base_size = 13) +
  labs(
    title = "Posterior vs Prior for Beta Parameters",
    subtitle = "Posterior densities (blue) vs diffuse Normal prior (red dashed)",
    x = "Coefficient Value",
    y = "Density"
  ) +
  scale_x_continuous(n.breaks = 4)
```

```{r}
#| label: fig-bay4
#| fig-cap: "Autocorrelation Plots for the Beta Parameters"
#| fig-width: 8
#| fig-height: 6

m_combined <- do.call(rbind, sim)

params_to_plot <- c(
  "beta_age",
  "beta_notify",
  "beta_transport",
  "beta_TPA",
  "beta_Thromb"
)

m_sub <- m_combined[, params_to_plot]
autocorr.plot(m_sub, lag.max = 40)
```

### Bayesian Results

```{r}
post_summary <- summary(sim)
stats <- post_summary$statistics
quants <- post_summary$quantiles

idx_beta <- grepl("^beta", rownames(stats))

beta_stats <- stats[idx_beta, ]
beta_quants <- quants[idx_beta, ]

ci_exclude_zero <- (beta_quants[,"2.5%"] > 0) | (beta_quants[,"97.5%"] < 0)

beta_table <- data.frame(
  Parameter = rownames(beta_stats),
  Mean = beta_stats[,"Mean"],
  CI_lower = beta_quants[,"2.5%"],
  CI_upper = beta_quants[,"97.5%"]
)

beta_sig <- beta_table[ci_exclude_zero, ]

kable(beta_sig, digits = 3, row.names = FALSE)
```
