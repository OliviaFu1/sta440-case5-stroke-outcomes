---
title: "STA 440 Case 5: Stroke Outcome"
author: "Sreya Gnanavel, Srika Gopal, Olivia Fu"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
format: 
  pdf:
    documentclass: article
    fontsize: 11pt
geometry: margin=1in
execute: 
  warning: false
  message: false
  echo: false
---

# Background

Stroke is a time-sensitive medical emergency and remains a leading cause of death and long-term disability in the United States. Many patients fail to recognize stroke symptoms or delay seeking treatment, and clinical outcomes worsen substantially with each minute that reperfusion therapy is delayed. Timely diagnosis and rapid initiation of treatment, either thrombolysis (TPA), mechanical thrombectomy, or both, are therefore central to improving survival and functional recovery.

To address delays in stroke care delivery, a regional quality-improvement program was implemented across nine comprehensive stroke centers between 2019 and 2020. The first two quarters of the study represent a baseline planning period, the next four quarters correspond to active implementation, and the final two quarters reflect the fully operational program. Data were collected quarterly on all ischemic stroke patients who received reperfusion therapy and presented to participating centers.

The primary research question is whether the probability of a good discharge outcome, defined as discharge to home or a rehabilitation facility rather than to skilled nursing, hospice, or death, (1) improved over the course of the program and (2) is associated with demographic, clinical, and treatment factors.

# Exploratory Data Analysis

The dataset contains 1,752 patient encounters with information on demographics, arrival mode (EMS vs. car), pre-hospital notification status, treatment characteristics, complications, and discharge disposition. Several variables exhibit substantial missingness, most notably Age (46%), PreHospNotify (12%), EMSvsCar (5%), Race2 (5%), and the outcome variable (3%) (Figure \@ref(fig:eda1)).

To characterize the missingness mechanism, we examined its distribution across key dimensions. Missingness was not uniform across sites (Figure \@ref(fig:eda2)); for example, Site 170 reported no Age values, and other variables also showed site-specific gaps, suggesting operational or reporting differences. Missingness also varied over time (Figure \@ref(fig:eda3)). Age and PreHospNotify were heavily missing in the early baseline period (Y1Q1) and improved in later quarters, consistent with early implementation and documentation challenges. Missingness further differed by outcome level (Figure \@ref(fig:eda4)), particularly for Age and PreHospNotify, indicating that the probability of being missing relates to other observed variables. Together, these patterns rule out a Missing Completely at Random (MCAR) mechanism. Because the missingness is unlikely to depend on the unobserved values themselves, we proceeded under a Missing at Random (MAR) assumption.

We also explored variation in demographic and clinical characteristics across sites and their relationships with discharge outcomes. Age distributions differed across centers, with some sites treating more older patients (Figure \@ref(fig:eda5)), and racial composition also varied, with certain hospitals serving predominantly Caucasian patients and others having higher proportions of African American or Other race groups (Figure \@ref(fig:eda6)). On the other hand, gender, pre-hospital notification, and arrival mode were relatively consistent across sites.

Observed associations with the outcome were clinically consistent. Patients with TPA or thrombectomy complications had much lower probabilities of home/rehab discharge; EMS arrival (a proxy for greater stroke severity) was also associated with worse outcomes, while TPA treatment corresponded to improved discharge disposition (Figure \@ref(fig:eda7)). Older age, female gender, and African American/Other race groups showed lower rates of favorable discharge (Figure \@ref(fig:eda8)). When outcomes were plotted over time, several sites showed modest improvement from baseline to the end of the study period, whereas others exhibited fluctuations or even declining trends (Figure \@ref(fig:eda9)). These observations underscored the need for statistical modeling that accounts for site heterogeneity, temporal trends, and the non-random missingness structure identified in the EDA.

# Model Rationale, Evaluation, and Results

## Frequentist Model

Given our goals, identifying factors associated with good discharge outcomes and assessing whether outcomes improved over time, we used a regression framework that adjusts for demographic, clinical, and treatment variables. Because patients were clustered within nine stroke centers and our EDA showed meaningful site-level differences, we first fit a mixed-effects logistic regression with a random intercept for site prior to moving to the Bayesian model. To capture broader temporal trends and reduce quarter-to-quarter noise, we collapsed the study timeline into three periods (baseline, middle, end). Age was centered for numerical stability. After completing multiple imputation, we fit this mixed-effects logistic regression on one completed dataset to obtain initial frequentist estimates.

$$
logit(P(homeOrRehab=1))=β_0​+ β_{\text{EMS}}​+β_{\text{PreHospNotify}}​+β_{\text{TPA}}+β_{\text{Thrombectomy}}+β_{\text{Complications}}+β_{\text{Age}}​+β_{\text{Period}}+β_{\text{Gender}}+β_{\text{Race}}+usiteID​.
$$

Model convergence was successful using the bobyqa optimizer. Residual diagnostics, including Pearson residual vs. fitted plots and binned residual plots, indicated no major systematic deviations, though typical heteroskedasticity patterns were present due to the binary outcome. Classification performance was moderate: overall accuracy was 77%, with high sensitivity (0.92) but lower specificity (0.41), reflecting that the model predicts good outcomes more reliably than poor ones.

Parameter estimates aligned with clinical expectations. Older age significantly decreased the odds of a good outcome (β = −0.068, p \< 0.001), as did thrombectomy treatment, TPA complications, and thrombectomy complications, likely reflecting the underlying stroke severity of these patients. The effect of age is strong and approximately linear, though mild curvature suggests that a nonlinear term or spline could improve fit. Treatment effects likely vary with age, but current models do not include interaction terms; exploring age × treatment interactions may clarify differential treatment responses across age groups. Female gender and African American race were also associated with lower odds of home/rehab discharge. However, TPA treatment significantly increased the odds of a good outcome (β = 0.467, p = 0.005). Arrival by EMS was associated with worse outcomes relative to car arrival, again consistent with EMS transporting more severe cases.

The program's time period effect was modest. The middle period did not differ significantly from baseline, while the end period showed a positive but borderline significant increase in good outcomes (β = 0.285, p = 0.099). This suggests a possible improvement in outcomes as the program reached full implementation, though the evidence is not strong at the frequentist 5% significance level.

## **Bayesian Model**

### **Rationale and Implementation**

### **Evaluation**

### Results

# Limitations, Future Directions, and Conclusion

\newpage

# Appendix

```{r}
load("./strokeStudy.RData")
```

```{r}
library(ggplot2)
library(naniar)
library(dplyr)
library(tidyr)
library(knitr)
library(patchwork)
library(lme4)
library(pROC)

```

# EDA

## Missing values

```{r}
# Missing -> NA for Race2
x <- x |>
  mutate(
    Race2 = na_if(Race2, "Missing")
  )
```

## Missing Data Analysis

```{r label = "eda1", fig.cap = "Missing Data", fig.show = 'hold'}
x |>
  select(where(~ any(is.na(.)))) |>
  vis_miss()
```

```{r label = "eda2", fig.cap = "Missing Data by Site", fig.show = 'hold'}
x |>
  select(-Time2) |>
  gg_miss_var(facet = siteID) +
  labs(title = "Missing Data by Variable and Site")
```

```{r label = "eda3", fig.cap = "Missing Heatmap by Quarter by Variable", fig.show = 'hold'}
vars_with_missing <- c("Age", "Race2", "EMSvsCar", "PreHospNotify", "homeOrRehab")

x |>
  mutate(across(all_of(vars_with_missing),
                ~ as.integer(is.na(.)),
                .names = "{.col}_miss")) |>
  
  pivot_longer(
    cols = ends_with("_miss"),
    names_to = "Variable",
    values_to = "Missing"
  ) |>
  
  group_by(Time2, Variable) |>
  summarise(prop_missing = mean(Missing), .groups = "drop") |>
  
  ggplot(aes(x = Time2, y = Variable, fill = prop_missing)) +
  geom_tile() +
  scale_fill_viridis_c(option = "plasma", name = "% Miss") +
  labs(
    title = "Missingness Heatmap by Quarter",
    x = "Study Quarter",
    y = "Variable"
  ) +
  theme_minimal() +
  scale_y_discrete(labels = ~ gsub("_miss", "", .x))
```

```{r label = "eda4", fig.cap = "Missingness by outcome", fig.show = 'hold'}
gg_miss_fct(x,fct=homeOrRehab)
```

## Covariates & Associations

```{r label = "eda5", echo = FALSE, warning = FALSE, message = FALSE, fig.cap = "Age Distribution by Site 1-9", fig.show = 'hold'}
ggplot(x, aes(x = Age)) +
  geom_histogram(bins = 20) +
  facet_wrap(~ siteID) +
  labs(title = "Age Distribution by Site", x="Age", y="Count") +
  theme_minimal()
```

```{r label = "eda6", echo = FALSE, warning = FALSE, message = FALSE, fig.cap = "Distribution by Site", fig.show = 'hold'}

p7 <- x |>
  group_by(siteID, Gender) |>
  summarise(n = n()) |>
  ggplot(aes(x = siteID, y = n, fill = Gender)) +
  geom_bar(stat="identity", position="fill") +
  labs(title="Gender Distribution by Site", y="Proportion") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

p8 <- x |>
  group_by(siteID, Race2) |>
  summarise(n = n()) |>
  ggplot(aes(x = siteID, y = n, fill = Race2)) +
  geom_bar(stat="identity", position="fill") +
  labs(title="Race Distribution by Site", y="Proportion") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

p9 <- x |>
  group_by(siteID, PreHospNotify) |>
  summarise(n = n()) |>
  ggplot(aes(x = siteID, y = n, fill = PreHospNotify)) +
  geom_bar(stat="identity", position="fill") +
  labs(title="Notification Distribution by Site", y="Proportion") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

x$EMSvsCar <- factor(as.integer(as.character(x$EMSvsCar)), levels = c(0, 1))

p10 <- x |>
  group_by(siteID, EMSvsCar) |>
  summarise(n = n()) |>
  ggplot(aes(x = siteID, y = n, fill = EMSvsCar)) +
  geom_bar(stat="identity", position="fill") +
  labs(title="Transport Distribution by Site", y="Proportion") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

(p7 + p8) / (p9 + p10)
```

```{r label = "eda7", fig.cap = "Patient discharge outcomes by treatment and pre-hospital factors", fig.show = 'hold'}
p1 <- ggplot(x, aes(x = hadTPA, fill = homeOrRehab)) +
  geom_bar(position = "fill") +
  labs(title = "By TPA Treatment", y = "Proportion") +
  theme_minimal()

p2 <- ggplot(x, aes(x = hadThrombectomy, fill = homeOrRehab)) +
  geom_bar(position = "fill") +
  labs(title = "By Thrombectomy", y = "Proportion") +
  theme_minimal()

p3 <- ggplot(x, aes(x = PreHospNotify, fill = homeOrRehab)) +
  geom_bar(position = "fill") +
  labs(title = "By Pre-Hospital Notification", y = "Proportion") +
  theme_minimal()

p4 <- ggplot(x, aes(x = EMSvsCar, fill = homeOrRehab)) +
  geom_bar(position = "fill") +
  labs(title = "By Arrival Method", y = "Proportion") +
  theme_minimal()

p5 <- ggplot(x, aes(x = thrComplic, fill = homeOrRehab)) +
  geom_bar(position = "fill") +
  labs(title = "By Thrombectomy \nComplications", y = "Proportion") +
  theme_minimal()

p6 <- ggplot(x, aes(x = tpaComplic, fill = homeOrRehab)) +
  geom_bar(position = "fill") +
  labs(title = "By TPA \nComplications", y = "Proportion") +
  theme_minimal()

(p1 + p2 + p3) / (p6 + p5 + p4) +
  plot_layout(guides = "collect") +
  plot_annotation(
    title = "Patient Discharge Outcomes by Treatment and Pre-Hospital Factors"
  )
```

```{r label = "eda8", fig.cap = "Patient discharge outcomes by demographic factors", fig.show = 'hold', fig.width=6, fig.height=6}
x$AgeGroup <- cut(
  x$Age,
  breaks = c(-Inf, 20, 40, 60, 80, Inf),
  labels = c("0–20", "20–40", "40–60", "60–80", "80+"),
  right = FALSE
)

p_age <- ggplot(x, aes(x = AgeGroup, fill = homeOrRehab)) +
  geom_bar(position = "fill") +
  labs(
    title = "Outcome by Age Group",
    x = "Age Group",
    y = "Proportion"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

p5 <- ggplot(x, aes(x = Gender, fill = homeOrRehab)) +
  geom_bar(position = "fill") +
  labs(title="Outcome by Gender", y="Proportion") +
  theme_minimal()

p6 <- ggplot(x, aes(x = Race2, fill = homeOrRehab)) +
  geom_bar(position = "fill") +
  labs(title = "Outcome by Race", y = "Proportion") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

p_age / (p5+p6) +
  plot_layout(guides = "collect") +
  theme(legend.position = "right")
```

```{r label = "eda9", fig.cap = "Outcomes change over time", fig.show = 'hold'}
x |>
  group_by(Time2, siteID) |>
  summarise(
    n = sum(!is.na(homeOrRehab)),
    GoodOutcome = mean(homeOrRehab, na.rm = TRUE),
    SE = sqrt(GoodOutcome * (1 - GoodOutcome) / n),
    .groups = "drop"
  ) |>
  ggplot(aes(x = Time2, y = GoodOutcome, group = siteID)) +
  geom_line() +
  geom_point() +
  geom_errorbar(aes(ymin = GoodOutcome - SE, ymax = GoodOutcome + SE),
                width = 0.1, alpha = 0.6) +
  facet_wrap(~siteID) +
  labs(
    title = "Proportion of Good Outcomes by Site Over Time",
    y = "Proportion Discharged to Home/Rehab",
    x = "Quarter"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

# Frequentist model

```{r}
# MICE
library(mice)
library(miceadds)

x$siteID <- as.integer(as.factor(x$siteID))
binary_vec <- c("EMSvsCar","PreHospNotify","homeOrRehab")
x[binary_vec] <- lapply(x[binary_vec], function(z) factor(z))
x$Race2 <- factor(x$Race2)

# Initialize method vector
mice_imp <- make.method(x)
mice_imp["Age"]           <- "2l.pan"     # hierarchical continuous
mice_imp["Race2"]         <- "polyreg"    # multinomial categorical
mice_imp["EMSvsCar"]      <- "logreg"     # binary
mice_imp["PreHospNotify"] <- "logreg"     # binary
mice_imp["homeOrRehab"]   <- "logreg"     # binary

# Predictor matrix
pred_matrix <- make.predictorMatrix(x)
pred_matrix["Age", "siteID"] <- -2
```

```{r}
# imp <- mice(
#   x,
#   m = 20,
#   method = mice_imp,
#   predictorMatrix = pred_matrix,
#   cluster = x$siteID,
#   seed = 2025
# )
```

```{r}
# saveRDS(imp, file = "imp_m20.rds")
imp <- readRDS("./imp_m20.rds")
```

```{r}
# ctrl <- glmerControl(optimizer = "bobyqa")
# 
# models <- with(
#   imp,
#   {
#     period <- case_when(
#       Time2 %in% c("Y1Q1", "Y1Q2") ~ "baseline",
#       Time2 %in% c("Y1Q3", "Y1Q4", "Y2Q1", "Y2Q2") ~ "middle",
#       Time2 %in% c("Y2Q3", "Y2Q4") ~ "end"
#     )
#     period <- factor(period, levels = c("baseline","middle","end"))
# 
#     Age_c <- Age - mean(Age, na.rm = TRUE)
# 
#     glmer(
#       homeOrRehab ~ EMSvsCar + PreHospNotify + hadThrombectomy +
#         hadTPA + tpaComplic + thrComplic + Age_c + period + Gender + Race2 +
#         (1 | siteID),
#       family = binomial,
#       control = ctrl
#     )
#   }
# )
```

```{r}
# saveRDS(models, file = "models_glmer_m20.rds")
models <- readRDS("models_glmer_m20.rds")
```

```{r}
est_list  <- lapply(models$analyses, fixef)
vcov_list <- lapply(models$analyses, vcov)
m <- length(est_list)
coef_names <- names(est_list[[1]])

# p x m matrix of estimates
Qmat <- do.call(cbind, lapply(est_list, function(b) b[coef_names]))

# p x m matrix of standard errors
SEmat <- sapply(models$analyses, function(mdl) sqrt(diag(vcov(mdl)[coef_names, coef_names])))
SEmat <- as.matrix(SEmat)
rownames(SEmat) <- coef_names

# pooled estimate
Q_bar <- rowMeans(Qmat)

# within-imputation variance (mean of SE^2)
U_bar <- rowMeans(SEmat^2)

# between-imputation variance
B <- apply(Qmat, 1, var)

# total variance
T_var <- U_bar + (1 + 1/m) * B

# pooled standard error
se_pooled <- sqrt(T_var)

z_val <- Q_bar / se_pooled
p_val <- 2 * (1 - pnorm(abs(z_val)))

pooled_results <- data.frame(
  term      = coef_names,
  estimate  = Q_bar,
  std.error = se_pooled,
  z         = z_val,
  p.value   = p_val
)

kable(pooled_results, digits = 3, row.names = FALSE)
```

```{r}
pred_list <- lapply(models$analyses, function(m) predict(m, type="response"))
y <- models$analyses[[1]]@frame$homeOrRehab

auc_list <- lapply(pred_list, function(p) roc(y, p)$auc)
auc_summary <- data.frame(
  Metric = c("Mean AUC", "SD of AUC"),
  Value  = c(mean(unlist(auc_list)), sd(unlist(auc_list)))
)

kable(auc_summary, digits = 3, row.names = FALSE)
```

```{r}
library(pROC)
library(ggplot2)

m1 <- models$analyses[[1]]
p1 <- predict(m1, type = "response")
y <- m1@frame$homeOrRehab
roc_obj <- roc(y, p1)

roc_df <- data.frame(
  tpr = roc_obj$sensitivities,
  fpr = 1 - roc_obj$specificities
)

ggplot(roc_df, aes(x = fpr, y = tpr)) +
  geom_line(color = "blue", size = 1.2) +
  geom_abline(linetype = "dashed") +
  coord_fixed(xlim = c(0,1), ylim = c(0,1)) +
  labs(
    x = "False Positive Rate (1 - Specificity)",
    y = "True Positive Rate (Sensitivity)",
    title = paste("ROC Curve (Imputation 1) | AUC =", round(roc_obj$auc, 3))
  ) +
  theme_bw()
```
