---
title: "STA 440 Case 5: Stroke Outcome"
author: "Sreya Gnanavel, Srika Gopal, Olivia Fu"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
format: 
  pdf:
    documentclass: article
    fontsize: 11pt
geometry: margin=1in
execute: 
  warning: false
  message: false
  echo: false
---

# Background

Stroke is a time-sensitive medical emergency and a leading cause of death and disability in the United States. Because many patients delay seeking care, outcomes worsen with each minute that reperfusion therapy is delayed. Rapid diagnosis and timely treatment, via thrombolysis (TPA), thrombectomy, or both, are therefore critical. To reduce delays in stroke care, a regional quality-improvement program was implemented across nine comprehensive stroke centers between 2019 and 2020. The first two quarters served as a baseline, the next four covered active implementation, and the final two reflected full operation. Quarterly data were collected on all ischemic stroke patients receiving reperfusion therapy.

Our primary research question is whether the probability of a good discharge outcome (home or rehabilitation vs skilled nursing, hospice, or death) (1) improved over the course of the program and (2) was associated with demographic, clinical, and treatment factors.

# Exploratory Data Analysis

The dataset contains 1,752 patient encounters with information on demographics, arrival mode (EMS vs. car), pre-hospital notification status, treatment characteristics, complications, and discharge disposition. Several variables exhibit substantial missingness, most notably Age (46%), PreHospNotify (12%), EMSvsCar (5%), Race2 (5%), and the outcome variable (3%) (@fig-eda1).

To assess the missingness mechanism, we examined patterns across sites, time, and outcomes. Missingness was clearly non-uniform across sites (e.g., Site 170 had no Age values) (@fig-eda2) and varied over time (@fig-eda3), with Age and PreHospNotify heavily missing early in the baseline period before improving in later quarters. Missingness also differed by outcome, particularly for Age and PreHospNotify (@fig-eda4). These patterns rule out Missing Completely at Random (MCAR). Because the missingness is unlikely to depend on the unobserved values themselves, we proceeded under a Missing at Random (MAR) assumption.

We also explored variation in demographic and clinical characteristics across sites and their relationships with discharge outcomes. Age distributions differed across centers, with some sites treating more older patients (@fig-eda5), and racial composition also varied, with certain hospitals serving predominantly Caucasian patients and others having higher proportions of African American or Other race groups (@fig-eda6). On the other hand, gender, pre-hospital notification, and arrival mode were relatively consistent across sites. Observed associations aligned with clinical expectations: TPA and thrombectomy complications and EMS arrival were linked to substantially lower probabilities of home/rehab discharge, whereas TPA treatment was associated with better outcomes (@fig-eda7). Older age, female gender, and African American/Other race groups also had lower rates of favorable discharge (@fig-eda8). Outcome trends varied across sites, some showed modest improvement over time, while others fluctuated or declined, highlighting substantial site-level heterogeneity (@fig-eda9). These patterns, along with the non-random missingness observed earlier, motivated a modeling approach that accounts for site effects, temporal trends, and structured missingness.

# Model Rationale, Evaluation, and Results

## Frequentist Model

We addressed missing data under the MAR assumption using multilevel MICE. Age was imputed with the `2l.pan` method (a two-level normal model with a site-level random intercept). Race2 was imputed with `polyreg` for its multinomial structure, and EMSvsCar, PreHospNotify, and homeOrRehab were imputed using `logreg`. In total, we generated 20 imputed datasets.

To identify factors associated with good discharge outcomes and assess changes over time, we fit a logistic regression that adjusted for demographic, clinical, and treatment variables. Given patient clustering and substantial site-level heterogeneity, we included a random intercept for site. To capture broader temporal trends, we collapsed the eight quarters into three periods (baseline, middle, end). Age was centered for stability. This model was applied to each of the 20 imputed datasets, and results were pooled to incorporate both within- and between-imputation uncertainty.

$$
\begin{aligned}\text{logit}\{P(\text{homeOrRehab}=1)\}&= \beta_0  + \beta_{\text{EMS}}  + \beta_{\text{PreHospNotify}}  + \beta_{\text{TPA}}  + \beta_{\text{Thrombectomy}}  + \beta_{\text{TPAComp}}  + \beta_{\text{ThrombComp}} \\&\quad + \beta_{\text{Age}}  + \beta_{\text{Period}}  + \beta_{\text{Gender}}  + \beta_{\text{Race}}  + u_{\text{siteID}}\end{aligned}
$$

We fit the logistic mixed-effects model using the `glmer` function from the `lme4` package, with the bobyqa optimizer to improve convergence. The imputations were highly stable across iterations. We examined the binned residual plots for all 20 imputations and found no substantial systematic deviations or concerning residual patterns. For illustration, we present the plot from imputation 1 (@fig-freq1). To evaluate predictive performance, we computed the mean AUC across all 20 imputed models, getting an average of 0.743 (Table 2). We also present the ROC curve for imputation 1 (@fig-freq2), which indicates high sensitivity but relatively weaker specificity, so the model identifies good outcomes more reliably than poor ones.

From the pooled regression results (Table 1), older age substantially reduced the odds of a good outcome ($\beta$ = –0.041, p \< 0.001). EMS arrival, thrombectomy, and both TPA- and thrombectomy-related complications also lowered the odds, reflecting greater stroke severity. Age was modeled as a linear predictor, although nonlinear effects may be present. Incorporating age–treatment interactions could further clarify how treatment effects vary across age. Female gender and African American race were similarly associated with worse outcomes. In contrast, TPA treatment significantly improved the odds of home/rehab discharge ( $\beta$= 0.570, p \< 0.001). Time-period effects were modest: the middle period was similar to baseline, and the end period showed a small, non-significant improvement ($\beta$ = 0.240, p = 0.175). This suggests a possible, though not statistically robust, improvement as the program reached full implementation, potentially due to site-level variability and its overlap with the COVID period.

## **Bayesian Model**

### **Rationale and Implementation**

For the Bayesian analysis, we modeled homeOrRehab as a Bernoulli outcome with a logit link and included fixed effects for site (9 centers), time (8 quarters), age, gender, race, EMS transport, pre-hospital notification, TPA, thrombectomy, and their complications. We tested alternative age specifications (log-age, age\^2, centering), but none improved convergence or model fit, so we retained a linear age term. We also tried modeling site as a random effect, but it did not improve fit or mixing, so we kept the fixed-effects structure. All eight time periods were included to preserve quarter-level variation.

Missing-data variables, Race, Transport, Pre-hospital notification, and Age, were modeled jointly. Race (3 categories) used a multinomial model with site-specific probabilities and Dirichlet(0.5) priors. Transport was modeled with a logistic regression including site and four clinical predictors. Pre-hospital notification was modeled as a logistic function of site, race, and time for EMS arrivals only, enforcing its structural dependence on EMS transport. Age was modeled as normal with a mean varying by site, race, and time. Predictors for each submodel were chosen from regressions on the missingness indicators and our reasoning about likely missingness mechanisms.

We assigned weakly informative priors to all regression coefficients, specifically Normal distributions with mean 0 and precision 0.001. For the Age variance, we placed a Gamma(0.001, 0.001) prior on the precision parameter. The model was estimated in JAGS using four chains, each run for 50,000 iterations with a burn-in of 10,000.

### **Evaluation**

We used standard Bayesian diagnostics for assesment, including trace plots, effective sample sizes (ESS), autocorrelation functions (ACF), and Gelman–Rubin $\hat{R}$ statistics. Trace plots for the primary regression coefficients (age, EMS transport, thrombectomy, tPA treatment, and treatment-related complications) showed tight, overlapping chains with no visible drift, indicating good mixing (@fig-bay1). The one exception was the age coefficient ($\beta{age}$), which mixed more slowly and had a lower ESS (Table 3). We tested several transformations (log age, quadratic age, centering), but none improved convergence. Despite the reduced ESS, $\beta{age}$ remained well-identified with a narrow posterior, so its interpretation is stable. ESS values for all other fixed-effect parameters were extremely high (often \>150,000), indicating strong chain independence (Table 3). ACF plots further supported this: most coefficients showed rapid autocorrelation decay, again with $\beta{age}$ as the only modest outlier, but still acceptable for inference (@fig-bay4).

Gelman–Rubin $\hat{R}$ values for the outcome-model parameters were all approximately 1.00, with upper bounds below 1.03 (@fig-bay2). Some parameters in the missing-data submodels (for example, delta_time and site_gamma effects) had higher $\hat{R}$ values and greater uncertainty, which is expected given weak identifiability of missingness mechanisms and does not affect inference for the outcome model. Posterior–prior comparisons (@fig-bay3) showed that the main clinical coefficients have posteriors substantially narrower than the diffuse Normal priors, indicating that the data were informative. In contrast, several gender, race, site, and time coefficients remained wide and weakly identified, indicating limited information in the data about their effects. We also plotted the ROC curve for the Bayesian model (@fig-bay5), which yielded an AUC of 0.8 and indicated moderate model fit.

### Results

When evaluating associations, we examined posterior means and 95% credible intervals (Table 4). We focused on effects whose credible intervals did not include zero. Age had a negative effect on the log-odds of a good outcome (–0.065). EMS transport (–1.266), thrombectomy (–0.582), and both TPA and thrombectomy complications (–1.377 and -1.421) also showed clearly negative effects. These intervals exclude 0, indicating strong evidence that these factors reduce the probability of home/rehab discharge. By contrast, TPA treatment showed a positive association (0.594), making it the only treatment variable with a credible interval fully above 0, consistent with improved outcomes. To address whether outcomes improved over time, we examined the posterior distributions for the eight quarterly time effects. All time coefficients had credible intervals that included 0, and their posterior means were small in magnitude, indicating weak evidence of systematic improvement over time in the Bayesian model. Site effects displayed similar uncertainty, with all site-level credible intervals overlapping 0. Together, these results indicate clear associations for key demographic and clinical variables but provide little evidence that the quality-improvement program produced measurable improvements in discharge outcomes over the study period.

# Limitations, Future Directions, and Conclusion

Our analysis relies on several assumptions. First, we assumed a linear relationship between age and the outcome, which may not reflect the true underlying pattern. Second, for sites with completely missing age information, we implicitly assumed their age distributions resembled those of other sites. Third, we did not include interaction terms and did not account for the effects of the overlapping COVID period. The models also have limitations. Some posterior distributions exhibited substantial uncertainty, as shown in our evaluation. A key limitation of the dataset is the high level of missingness in several important variables (PreHospNotify, EMSTransport, Race, and Age), requiring imputation based on our modeled structures. Measurement inconsistencies across sites and quarters may have introduced additional noise. Because of substantial site-to-site variability, we could not estimate time effects with precision. Future work should explore interaction effects, adopt more flexible imputation strategies, and consider alternative priors to improve identifiability.

Overall, across both frequentist and Bayesian models, younger age and TPA treatment were consistently associated with better outcomes, whereas EMS transport, thrombectomy, and treatment-related complications were associated with worse outcomes, likely reflecting greater baseline severity. We found no strong evidence of systematic improvement over the study period, and the uncertainty surrounding these effects suggests that centers may benefit from reassessing both their individual and collective performance in stroke outcome management.

\newpage

# Appendix

```{r}
load("./strokeStudy.RData")
```

```{r}
library(ggplot2)
library(naniar)
library(dplyr)
library(tidyr)
library(knitr)
library(patchwork)
library(lme4)
library(pROC)
library(ggplot2)
library(rjags)
library(R2jags)
library(coda)
```

```{r}
# Missing -> NA for Race2
x <- x |>
  mutate(
    Race2 = na_if(Race2, "Missing")
  )
```

```{r}
#| label: fig-eda1
#| fig-cap: "Missing Data"
#| fig.height: 6
#| fig.width: 8

x |>
  select(where(~ any(is.na(.)))) |>
  vis_miss() +
  labs(title = "Missingness Pattern Across Key Variables")
```

```{r, fig.height=6, fig.width=8}
#| label: fig-eda2
#| fig-cap: "Missing Data by Site"

x |>
  select(-Time2) |>
  gg_miss_var(facet = siteID) +
  labs(title = "Missing Data by Variable and Site")
```

```{r}
#| label: fig-eda3
#| fig-cap: "Missing Heatmap by Quarter by Variable"

vars_with_missing <- c("Age", "Race2", "EMSvsCar", "PreHospNotify", "homeOrRehab")

x |>
  mutate(across(all_of(vars_with_missing),
                ~ as.integer(is.na(.)),
                .names = "{.col}_miss")) |>
  
  pivot_longer(
    cols = ends_with("_miss"),
    names_to = "Variable",
    values_to = "Missing"
  ) |>
  
  group_by(Time2, Variable) |>
  summarise(prop_missing = mean(Missing), .groups = "drop") |>
  
  ggplot(aes(x = Time2, y = Variable, fill = prop_missing)) +
  geom_tile() +
  scale_fill_viridis_c(option = "plasma", name = "% Miss") +
  labs(
    title = "Missingness Heatmap by Quarter",
    x = "Study Quarter",
    y = "Variable"
  ) +
  theme_minimal() +
  scale_y_discrete(labels = ~ gsub("_miss", "", .x))
```

```{r}
#| label: fig-eda4
#| fig-cap: "Missingness by outcome"

gg_miss_fct(x,fct=homeOrRehab) +
  labs(title = "Missigness by Outcome variable")
```

```{r}
#| label: fig-eda5
#| fig-cap: "Age Distribution by Site 1-9"

ggplot(x, aes(x = Age)) +
  geom_histogram(bins = 20) +
  facet_wrap(~ siteID) +
  labs(title = "Age Distribution by Site", x="Age", y="Count") +
  theme_minimal()
```

```{r, fig.height=6, fig.width=8}
#| label: fig-eda6
#| fig-cap: "Demographic Distribution by Site"

p7 <- x |>
  group_by(siteID, Gender) |>
  summarise(n = n()) |>
  ggplot(aes(x = siteID, y = n, fill = Gender)) +
  geom_bar(stat="identity", position="fill") +
  labs(title="Gender Distribution by Site", y="Proportion") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

p8 <- x |>
  group_by(siteID, Race2) |>
  summarise(n = n()) |>
  ggplot(aes(x = siteID, y = n, fill = Race2)) +
  geom_bar(stat="identity", position="fill") +
  labs(title="Race Distribution by Site", y="Proportion") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

p9 <- x |>
  group_by(siteID, PreHospNotify) |>
  summarise(n = n()) |>
  ggplot(aes(x = siteID, y = n, fill = PreHospNotify)) +
  geom_bar(stat="identity", position="fill") +
  labs(title="Notification Distribution by Site", y="Proportion") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

x$EMSvsCar <- factor(as.integer(as.character(x$EMSvsCar)), levels = c(0, 1))

p10 <- x |>
  group_by(siteID, EMSvsCar) |>
  summarise(n = n()) |>
  ggplot(aes(x = siteID, y = n, fill = EMSvsCar)) +
  geom_bar(stat="identity", position="fill") +
  labs(title="Transport Distribution by Site", y="Proportion") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

(p7 + p8) / (p9 + p10)
```

```{r, fig.height=6, fig.width=8}
#| label: fig-eda7
#| fig-cap: "Patient discharge outcomes by treatment and pre-hospital factors"

p1 <- ggplot(x, aes(x = hadTPA, fill = homeOrRehab)) +
  geom_bar(position = "fill") +
  labs(title = "By TPA Treatment", y = "Proportion") +
  theme_minimal()

p2 <- ggplot(x, aes(x = hadThrombectomy, fill = homeOrRehab)) +
  geom_bar(position = "fill") +
  labs(title = "By Thrombectomy", y = "Proportion") +
  theme_minimal()

p3 <- ggplot(x, aes(x = PreHospNotify, fill = homeOrRehab)) +
  geom_bar(position = "fill") +
  labs(title = "By Pre-Hospital Notification", y = "Proportion") +
  theme_minimal()

p4 <- ggplot(x, aes(x = EMSvsCar, fill = homeOrRehab)) +
  geom_bar(position = "fill") +
  labs(title = "By Arrival Method", y = "Proportion") +
  theme_minimal()

p5 <- ggplot(x, aes(x = thrComplic, fill = homeOrRehab)) +
  geom_bar(position = "fill") +
  labs(title = "By Thrombectomy \nComplications", y = "Proportion") +
  theme_minimal()

p6 <- ggplot(x, aes(x = tpaComplic, fill = homeOrRehab)) +
  geom_bar(position = "fill") +
  labs(title = "By TPA \nComplications", y = "Proportion") +
  theme_minimal()

(p1 + p2 + p3) / (p6 + p5 + p4) +
  plot_layout(guides = "collect") +
  plot_annotation(
    title = "Patient Discharge Outcomes by Treatment and Pre-Hospital Factors"
  )
```

```{r}
#| label: fig-eda8
#| fig-cap: "Patient discharge outcomes by demographic factors"
#| fig-width: 6
#| fig-height: 6

x$AgeGroup <- cut(
  x$Age,
  breaks = c(-Inf, 20, 40, 60, 80, Inf),
  labels = c("0–20", "20–40", "40–60", "60–80", "80+"),
  right = FALSE
)

p_age <- ggplot(x, aes(x = AgeGroup, fill = homeOrRehab)) +
  geom_bar(position = "fill") +
  labs(
    title = "Outcome by Age Group",
    x = "Age Group",
    y = "Proportion"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

p5 <- ggplot(x, aes(x = Gender, fill = homeOrRehab)) +
  geom_bar(position = "fill") +
  labs(title="Outcome by Gender", y="Proportion") +
  theme_minimal()

p6 <- ggplot(x, aes(x = Race2, fill = homeOrRehab)) +
  geom_bar(position = "fill") +
  labs(title = "Outcome by Race", y = "Proportion") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

p_age / (p5+p6) +
  plot_layout(guides = "collect") +
  theme(legend.position = "right")
```

```{r}
#| label: fig-eda9
#| fig-cap: "Outcomes change over time"

x |>
  group_by(Time2, siteID) |>
  summarise(
    n = sum(!is.na(homeOrRehab)),
    GoodOutcome = mean(homeOrRehab, na.rm = TRUE),
    SE = sqrt(GoodOutcome * (1 - GoodOutcome) / n),
    .groups = "drop"
  ) |>
  ggplot(aes(x = Time2, y = GoodOutcome, group = siteID)) +
  geom_line() +
  geom_point() +
  geom_errorbar(aes(ymin = GoodOutcome - SE, ymax = GoodOutcome + SE),
                width = 0.1, alpha = 0.6) +
  facet_wrap(~siteID) +
  labs(
    title = "Proportion of Good Outcomes by Site Over Time",
    y = "Proportion Discharged to Home/Rehab",
    x = "Quarter"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
# MICE
library(mice)
library(miceadds)

x$siteID <- as.integer(as.factor(x$siteID))
binary_vec <- c("EMSvsCar","PreHospNotify","homeOrRehab")
x[binary_vec] <- lapply(x[binary_vec], function(z) factor(z))
x$Race2 <- factor(x$Race2)

# Initialize method vector
mice_imp <- make.method(x)
mice_imp["Age"]           <- "2l.pan"     # hierarchical continuous
mice_imp["Race2"]         <- "polyreg"    # multinomial categorical
mice_imp["EMSvsCar"]      <- "logreg"     # binary
mice_imp["PreHospNotify"] <- "logreg"     # binary
mice_imp["homeOrRehab"]   <- "logreg"     # binary

# Predictor matrix
pred_matrix <- make.predictorMatrix(x)
pred_matrix["Age", "siteID"] <- -2
```

```{r}
# imp <- mice(
#   x,
#   m = 20,
#   method = mice_imp,
#   predictorMatrix = pred_matrix,
#   cluster = x$siteID,
#   seed = 2025
# )
```

```{r}
# saveRDS(imp, file = "imp_m20.rds")
imp <- readRDS("./imp_m20.rds")
```

```{r}
# ctrl <- glmerControl(optimizer = "bobyqa")
# 
# models <- with(
#   imp,
#   {
#     period <- case_when(
#       Time2 %in% c("Y1Q1", "Y1Q2") ~ "baseline",
#       Time2 %in% c("Y1Q3", "Y1Q4", "Y2Q1", "Y2Q2") ~ "middle",
#       Time2 %in% c("Y2Q3", "Y2Q4") ~ "end"
#     )
#     period <- factor(period, levels = c("baseline","middle","end"))
# 
#     Age_c <- Age - mean(Age, na.rm = TRUE)
# 
#     glmer(
#       homeOrRehab ~ EMSvsCar + PreHospNotify + hadThrombectomy +
#         hadTPA + tpaComplic + thrComplic + Age_c + period + Gender + Race2 +
#         (1 | siteID),
#       family = binomial,
#       control = ctrl
#     )
#   }
# )
```

```{r}
# saveRDS(models, file = "models_glmer_m20.rds")
models <- readRDS("models_glmer_m20.rds")
```

```{r}
est_list  <- lapply(models$analyses, fixef)
vcov_list <- lapply(models$analyses, vcov)
m <- length(est_list)
coef_names <- names(est_list[[1]])

# p x m matrix of estimates
Qmat <- do.call(cbind, lapply(est_list, function(b) b[coef_names]))

# p x m matrix of standard errors
SEmat <- sapply(models$analyses, function(mdl) sqrt(diag(vcov(mdl)[coef_names, coef_names])))
SEmat <- as.matrix(SEmat)
rownames(SEmat) <- coef_names

# pooled estimate
Q_bar <- rowMeans(Qmat)

# within-imputation variance (mean of SE^2)
U_bar <- rowMeans(SEmat^2)

# between-imputation variance
B <- apply(Qmat, 1, var)

# total variance
T_var <- U_bar + (1 + 1/m) * B

# pooled standard error
se_pooled <- sqrt(T_var)

z_val <- Q_bar / se_pooled
p_val <- 2 * (1 - pnorm(abs(z_val)))

pooled_results <- data.frame(
  term      = coef_names,
  estimate  = Q_bar,
  std.error = se_pooled,
  z         = z_val,
  p.value   = p_val
)

kable(pooled_results, digits = 3, row.names = FALSE,
      caption = "Pooled Summary for Frequentist Model")
```

```{r}
pred_list <- lapply(models$analyses, function(m) predict(m, type="response"))
y <- models$analyses[[1]]@frame$homeOrRehab

auc_list <- lapply(pred_list, function(p) roc(y, p)$auc)
auc_summary <- data.frame(
  Metric = c("Mean AUC", "SD of AUC"),
  Value  = c(mean(unlist(auc_list)), sd(unlist(auc_list)))
)

kable(auc_summary, digits = 3, row.names = FALSE,
      caption = "Mean AUC and SD Across 20 Imputations")
```

```{r}
#| label: fig-freq1
#| fig-cap: "Binned Residual Plot for Imputation 1"

m1 <- models$analyses[[1]]
p1 <- predict(m1, type = "response")
y <- ifelse(m1@frame$homeOrRehab == "TRUE", 1, 0)

pearson_res <- (y - p1) / sqrt(p1 * (1 - p1))

library(arm)

binnedplot(
  x     = p1,
  y     = pearson_res,
  xlab = "Fitted Probability",
  ylab = "Pearson Residual",
  main = "Binned Residual Plot (Imputation 1)"
)
```

```{r}
#| label: fig-freq2
#| fig-cap: "ROC plot for Frequentist Model"

roc_obj <- roc(y, p1)

roc_df <- data.frame(
  tpr = roc_obj$sensitivities,
  fpr = 1 - roc_obj$specificities
)

ggplot(roc_df, aes(x = fpr, y = tpr)) +
  geom_line(color = "blue", size = 1.2) +
  geom_abline(linetype = "dashed") +
  coord_fixed(xlim = c(0,1), ylim = c(0,1)) +
  labs(
    x = "False Positive Rate (1 - Specificity)",
    y = "True Positive Rate (Sensitivity)",
    title = paste("ROC Curve (Imputation 1) | AUC =", round(roc_obj$auc, 3))
  ) +
  theme_bw()
```

```{r}
load("./strokeStudy.RData")
```

```{r}
x$Race2[x$Race2=="Missing"] <- NA
x$Race2<-factor(x$Race2)

# Convert all factors to integer indices
x$siteID  <- as.numeric(factor(x$siteID))   # becomes 1..9
x$Time2   <- as.numeric(factor(x$Time2))    # becomes 1..8
x$Gender  <- as.numeric(factor(x$Gender))   # becomes 1..2
x$Race2   <- as.numeric(factor(x$Race2))    # becomes 1..3

# Convert logicals to 0/1
logical_vars <- c("hadTPA","hadThrombectomy","tpaComplic","thrComplic","homeOrRehab")
x[logical_vars] <- lapply(x[logical_vars], function(v) as.numeric(v))

# Convert PreHospNotify (Yes/No) to 0/1
x$PreHospNotify <- ifelse(x$PreHospNotify == "Yes", 1,
                           ifelse(x$PreHospNotify == "No", 0, NA))

# Convert EMSvsCar (currently dbl) to 0/1 integer
x$EMSvsCar <- as.integer(x$EMSvsCar)

# Set EMSvsCar = 1 if PreHospNotify = 1
x$EMSvsCar[is.na(x$EMSvsCar) & x$PreHospNotify == 1] <- 1
x$M_A      <- ifelse(is.na(x$Age), 1, 0)
x$M_notify <- ifelse(is.na(x$PreHospNotify), 1, 0)
x$M_trans  <- ifelse(is.na(x$EMSvsCar), 1, 0)
x$M_race   <- ifelse(is.na(x$Race2), 1, 0)
age_mean <- mean(x$Age, na.rm = TRUE)

# Build the data list for JAGS
bdat <- list(
  N = nrow(x),
  Y = x$homeOrRehab,
  Site = x$siteID,
  Time = x$Time2,
  Age = x$Age,
  Gender = x$Gender,
  Race = x$Race2,
  Transport = x$EMSvsCar,
  Notify = x$PreHospNotify,
  hadTPA = x$hadTPA,
  hadThrombectomy = x$hadThrombectomy,
  tpaComplic = x$tpaComplic,
  thrComplic = x$thrComplic
)

fun.params <- c(
  # outcome model
  "beta0","beta_site","beta_time","beta_age","beta_gender","beta_race",
  "beta_transport","beta_notify","beta_TPA","beta_Thromb",
  "beta_tpaComp","beta_thrComp",

  # Race model
  "pi_race",

  # Transport model
  "gamma0","gamma_site","gamma_Thromb","gamma_TPA",
  "gamma_thrComp","gamma_tpaComp",

  # Notify model
  "delta0","delta_site","delta_time",

  # Age model
  "eta0","eta_site","eta_race","eta_time",
  "sigma_A"
)

set.seed(440)
fun.model.file <- "model_stroke.R" 
mcmc.pars <- list(iter = 10000, burn = 2000, nchain=4, thin=1)

# jags.out <- jags(
#   data = bdat,
#   inits = NULL,
#   parameters.to.save = fun.params,
#   model.file = fun.model.file,
#   n.chains = mcmc.pars$nchain,
#   n.iter = mcmc.pars$iter,
#   n.burnin = mcmc.pars$burn,
#   n.thin = mcmc.pars$thin,
#   DIC = FALSE,
#   progress.bar = "none"
# )
```

```{r}
load("bayes_model_run_final.RData")
```

```{r}
sim <- as.mcmc(jags.out)
ess <- effectiveSize(sim)

df_ess <- data.frame(
  parameter = names(ess),
  ESS = as.numeric(ess)
)

df_beta <- df_ess[grepl("^beta", df_ess$parameter), ]

kable(df_beta, caption = "ESS for Beta Parameters")
```

```{r}
#| label: fig-bay1
#| fig-cap: "Trace Plots for Beta Parameters"
#| fig-height: 8
#| fig-width: 8

selected_betas <- c(
  "beta_age",
  "beta_gender[1]",
  "beta_race[1]",
  "beta_transport",
  "beta_notify",
  "beta_TPA",
  "beta_Thromb",
  "beta_tpaComp",
  "beta_thrComp",
  "beta_site[1]",
  "beta_time[1]"
)

param_data <- lapply(selected_betas, function(p) sim[, p])
names(param_data) <- selected_betas

par(mfrow = c(3, 4), mar = c(2, 2, 1, 1))

for (param in selected_betas) {
  traceplot(param_data[[param]], main = param, col = 1:4)
}
```

```{r, fig.height=6, fig.width=8}
#| label: fig-bay2
#| fig-cap: "Gelman-Rubin Rhat Values for Beta Parameters"

gelman_results <- gelman.diag(sim, transform=TRUE)
psrf_df <- as.data.frame(gelman_results$psrf)
psrf_df$Parameter <- rownames(psrf_df)
colnames(psrf_df) <- c("Point_Est", "Upper_CI", "Parameter")

psrf_beta <- psrf_df |> 
  filter(grepl("^beta", Parameter))

ggplot(psrf_beta, aes(x = Point_Est, y = reorder(Parameter, Point_Est))) +
  geom_point(size = 2, color = "steelblue") +
  geom_errorbarh(aes(xmin = Point_Est, xmax = Upper_CI),
                 height = 0.15, color = "gray50") +
  geom_vline(xintercept = 1, linetype = "solid", color = "darkgray") +
  geom_vline(xintercept = 1.01, linetype = "dashed", color = "orange") +
  geom_vline(xintercept = 1.05, linetype = "dashed", color = "red") +
  coord_cartesian(xlim = c(0.995, 1.06)) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.y = element_text(size = 8),
    panel.grid.major.y = element_blank()
  ) +
  labs(
    y = "",
    x = expression(hat(R)),
    title = "Gelman–Rubin Diagnostic for β Parameters"
  )
```

```{r, fig.height=6, fig.width=8}
#| label: fig-bay3
#| fig-cap: "Posterior vs. Prior Distributions for the Beta Parameters"

post <- do.call(rbind, sim)

selected_betas <- c(
  "beta_age",
  "beta_gender[1]",
  "beta_race[1]",
  "beta_transport",
  "beta_notify",
  "beta_TPA",
  "beta_Thromb",
  "beta_tpaComp",
  "beta_thrComp",
  "beta_site[1]",
  "beta_time[1]"
)

beta_post <- post[, selected_betas, drop = FALSE]

df_long <- as.data.frame(beta_post) |>
  mutate(iter = 1:n()) |>
  pivot_longer(
    cols = all_of(selected_betas),
    names_to = "Parameter",
    values_to = "Posterior"
  )

prior_mean <- 0
prior_sd   <- sqrt(1 / 0.001)

ggplot(df_long, aes(x = Posterior)) +
  geom_density(fill = "steelblue", alpha = 0.4, size = 0.6) +
  stat_function(
    fun = dnorm,
    args = list(mean = prior_mean, sd = prior_sd),
    color = "red", linetype = "dashed", size = 0.7
  ) +
  facet_wrap(~ Parameter, scales = "free", ncol = 4) +
  theme_minimal(base_size = 13) +
  labs(
    title = "Posterior vs Prior for Beta Parameters",
    subtitle = "Posterior densities (blue) vs diffuse Normal prior (red dashed)",
    x = "Coefficient Value",
    y = "Density"
  ) +
  scale_x_continuous(n.breaks = 4)
```

```{r}
#| label: fig-bay4
#| fig-cap: "Autocorrelation Plots for the Beta Parameters"
#| fig-width: 8
#| fig-height: 6

m_combined <- do.call(rbind, sim)

params_to_plot <- c(
  "beta_age",
  "beta_notify",
  "beta_transport",
  "beta_TPA",
  "beta_Thromb"
)

m_sub <- m_combined[, params_to_plot]
autocorr.plot(m_sub, lag.max = 40)
```

```{r}
post_summary <- summary(sim)
stats <- post_summary$statistics
quants <- post_summary$quantiles

idx_beta <- grepl("^beta", rownames(stats))

beta_stats <- stats[idx_beta, ]
beta_quants <- quants[idx_beta, ]

ci_exclude_zero <- (beta_quants[,"2.5%"] > 0) | (beta_quants[,"97.5%"] < 0)

beta_table <- data.frame(
  Parameter = rownames(beta_stats),
  Mean = beta_stats[,"Mean"],
  CI_lower = beta_quants[,"2.5%"],
  CI_upper = beta_quants[,"97.5%"]
)

beta_sig <- beta_table[ci_exclude_zero, ]

kable(beta_sig, digits = 3, row.names = FALSE,
      caption = "Posterior Results for Bayesian Model")
```

```{r}
#| label: fig-bay5
#| fig-cap: "ROC Curve for Bayesian Model"

vars <- varnames(sim)
sim_mat <- do.call(rbind, sim)

beta0     <- sim_mat[, "beta0"]
beta_site <- sim_mat[, grep("^beta_site\\[", vars)]
beta_time <- sim_mat[, grep("^beta_time\\[", vars)]
beta_gender <- sim_mat[, grep("^beta_gender\\[", vars)]
beta_race   <- sim_mat[, grep("^beta_race\\[", vars)]
beta_age      <- sim_mat[, "beta_age"]
beta_trans    <- sim_mat[, "beta_transport"]
beta_notify   <- sim_mat[, "beta_notify"]
beta_TPA      <- sim_mat[, "beta_TPA"]
beta_Thromb   <- sim_mat[, "beta_Thromb"]
beta_tpaComp  <- sim_mat[, "beta_tpaComp"]
beta_thrComp  <- sim_mat[, "beta_thrComp"]

Site            <- x$siteID
Time            <- x$Time2
Age             <- x$Age
Gender          <- x$Gender
Race            <- x$Race2
Transport       <- x$EMSvsCar           # 1 = EMS, 0 = Car
Notify          <- x$PreHospNotify
hadTPA          <- x$hadTPA
hadThrombectomy <- x$hadThrombectomy
tpaComplic      <- x$tpaComp
thrComplic      <- x$thrComp
Y               <- x$homeOrRehab        # 1 = home, 0 = rehab

M <- nrow(sim_mat)
N <- length(Y)

lp <- matrix(0, nrow = M, ncol = N)

lp <- lp +
  beta0 + 
  beta_site[, Site] +
  beta_time[, Time] +
  beta_age * matrix(Age, M, N, TRUE) +
  beta_gender[, Gender] +
  beta_race[, Race] +
  beta_trans * matrix(Transport, M, N, TRUE) +
  beta_notify * matrix(Notify, M, N, TRUE) +
  beta_TPA * matrix(hadTPA, M, N, TRUE) +
  beta_Thromb * matrix(hadThrombectomy, M, N, TRUE) +
  beta_tpaComp * matrix(tpaComplic, M, N, TRUE) +
  beta_thrComp * matrix(thrComplic, M, N, TRUE)

invlogit <- function(x) 1 / (1 + exp(-x))
p_samples <- invlogit(lp)

p_mean <- colMeans(p_samples)
roc_obj <- roc(Y, p_mean)

roc_df <- data.frame(
  tpr = roc_obj$sensitivities,
  fpr = 1 - roc_obj$specificities
)

ggplot(roc_df, aes(x = fpr, y = tpr)) +
  geom_line(color = "blue", size = 1.2) +
  geom_abline(linetype = "dashed") +
  coord_fixed(xlim = c(0,1), ylim = c(0,1)) +
  labs(
    x = "False Positive Rate (1 - Specificity)",
    y = "True Positive Rate (Sensitivity)",
    title = paste("ROC Curve | AUC =", round(roc_obj$auc, 3))
  ) +
  theme_bw()
```
