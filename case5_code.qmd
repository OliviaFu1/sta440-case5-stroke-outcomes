---
title: "case5_code"
format: html
editor: visual
---

```{r}
load("./strokeStudy.RData")
```

```{r}
library(ggplot2)
library(naniar)
library(dplyr)
library(tidyr)
library(knitr)
library(patchwork)
```

# EDA

## Missing values

```{r}
# Missing -> NA for Race2
x <- x |>
  mutate(Race2 = na_if(Race2, "Missing"),
         EMSvsCar = as.factor(EMSvsCar))
```

```{r}
x |>
  select(-Time2) |>
  gg_miss_var(facet = siteID) +
  labs(title = "Missing Data by Variable and Site")
```

```{r}
missing_count <- x |>
  select(-Time2, -siteID) |>
  summarise(across(
    everything(),
    ~ sum(is.na(.))
  )) |>
  pivot_longer(everything(),
               names_to = "Variable",
               values_to = "n_missing") %>%
  arrange(desc(n_missing))

kable(missing_count)
```

```{r}
vars_to_check <- c("Age", "PreHospNotify", "EMSvsCar", "homeOrRehab", "Race2")

missing_by_time <- x |>
  group_by(Time2) |>
  summarise(across(all_of(vars_to_check), ~sum(is.na(.)))) |>
  pivot_longer(-Time2, names_to = "Variable", values_to = "n_missing")

ggplot(missing_by_time, aes(x = Time2, y = n_missing, group = Variable, color = Variable)) +
  geom_line(size = 1) +
  geom_point(size = 3) +
  labs(title = "Missing Value Counts by Quarter",
       x = "Time (Quarter)",
       y = "Number of Missing Values",
       color = "Variable") +
  theme_minimal(base_size = 14) +
  scale_color_brewer(palette = "Set2")
```

## Missing Data Analysis
```{r}
library(naniar)
vis_miss(x)

gg_miss_var(x)
gg_miss_fct(x,fct=homeOrRehab)


x_subset<-x

x_subset$missingvals<-is.na(x)

#summary(glm(missingvals~homeOrRehab,data=x_subset))



#checking for mcar

complete_subset<- x[complete.cases(x),]
incomplete_subset<-x[!complete.cases(x),]

summary(complete_subset)
summary(incomplete_subset)

ggplot(x,aes(x=homeOrRehab,fill=complete.cases(x)))+geom_density(alpha=0.5) #not mcar, must be mnar or mar




```



## Covariates & Associations

```{r}
ggplot(x, aes(x = Age)) +
  geom_histogram(bins = 20) +
  facet_wrap(~ siteID) +
  labs(title = "Age Distribution by Site", x="Age", y="Count") +
  theme_minimal()

x |>
  group_by(siteID, Gender) |>
  summarise(n = n()) |>
  ggplot(aes(x = siteID, y = n, fill = Gender)) +
  geom_bar(stat="identity", position="fill") +
  labs(title="Gender Distribution by Site", y="Proportion") +
  theme_minimal()

x |>
  group_by(siteID, Race2) |>
  summarise(n = n()) |>
  ggplot(aes(x = siteID, y = n, fill = Race2)) +
  geom_bar(stat="identity", position="fill") +
  labs(title="Gender Distribution by Site", y="Proportion") +
  theme_minimal()
```

```{r}
p1 <- ggplot(x, aes(x = hadTPA, fill = homeOrRehab)) +
  geom_bar(position = "fill") +
  labs(title="Outcome by TPA Treatment", y="Proportion") +
  theme_minimal()

p2 <- ggplot(x, aes(x = hadThrombectomy, fill = homeOrRehab)) +
  geom_bar(position = "fill") +
  labs(title="Outcome by Thrombectomy Treatment", y="Proportion") +
  theme_minimal()

p3 <- ggplot(x, aes(x = PreHospNotify, fill = homeOrRehab)) +
  geom_bar(position = "fill") +
  labs(title="Outcome by Pre Hospital Notify", y="Proportion") +
  theme_minimal()

p4 <- ggplot(x, aes(x = EMSvsCar, fill = homeOrRehab)) +
  geom_bar(position = "fill") +
  labs(title="Outcome by EMS vs Car", y="Proportion") +
  theme_minimal()

(p1+p2) / (p3+p4) +
  plot_layout(guides = "collect") +
  theme(legend.position = "right")
```

```{r}
p5 <- ggplot(x, aes(x = Gender, fill = homeOrRehab)) +
  geom_bar(position = "fill") +
  labs(title="Outcome by Gender", y="Proportion") +
  theme_minimal()

p6 <- ggplot(x, aes(x = Race2, fill = homeOrRehab)) +
  geom_bar(position = "fill") +
  labs(title="Outcome by Race", y="Proportion") +
  theme_minimal()

p7 <- ggplot(x, aes(x = thrComplic, fill = homeOrRehab)) +
  geom_bar(position = "fill") +
  labs(title="Outcome by Complications \n During Thrombectomy \nSurgery", y="Proportion") +
  theme_minimal()

p8 <- ggplot(x, aes(x = tpaComplic, fill = homeOrRehab)) +
  geom_bar(position = "fill") +
  labs(title="Outcome by \nComplications During TPA \nSurgery", y="Proportion") +
  theme_minimal()

(p5+p6) / (p7+p8) +
  plot_layout(guides = "collect") +
  theme(legend.position = "right")
```




```{r}
x |>
  group_by(Time2, siteID) |>
  summarise(GoodOutcome = mean(homeOrRehab, na.rm = TRUE), .groups = "drop") |>
  ggplot(aes(x = Time2, y = GoodOutcome, group = siteID)) +  
  geom_line() +
  geom_point() +
  facet_wrap(~siteID) +
  labs(
    title = "Proportion of Good Outcomes by Site Over Time",
    y = "Proportion Discharged to Home/Rehab",
    x = "Quarter"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

# Frequentist model
```{r}
linear_model<-glm(homeOrRehab~., x,family=binomial)
summary(linear_model)
```



# Bayesian model
